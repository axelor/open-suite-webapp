import{an as Fs,Q as zt,r as s,aM as Os,aN as Bs,aO as Ys,U as ce,aP as Us,aQ as Gs,Z as Ie,$ as Kt,aR as Ls,j as o,B as b,O as Hs,D as y,aS as tt,E as st,aT as Ws,aU as qs,aw as zs,aV as Ks,aW as Qs,aX as Zs,aY as Ze,ah as Qt,aZ as Js,J as Tt,ai as Vt,a_ as Zt,a$ as Xs,ad as Jt,ae as Xt,t as nt,b0 as ie,b1 as en,b2 as tn,b3 as sn,h as es,b4 as nn,e as on,b5 as an,b6 as rn,P as cn,b7 as ln,b8 as dn,b9 as un,a4 as mn,ba as fn,S as pn,i as hn,V as $t,q as wn,H as Me,a as yn,ar as xn,as as Ft,au as gn,aE as Ot,bb as bn,bc as Bt,bd as vn,be as Cn,bf as Dn,W as Sn,_ as kn,k as Yt,n as jn,av as Ut,v as _n,bg as Rn,bh as Nn,bi as L,a0 as An,bj as Mn,a1 as En,a2 as In,bk as Pn,a8 as Tn,ak as Gt,bl as Vn,bm as $n,a3 as Fn,bn as On,bo as Bn}from"./index-tEJzJsUq.js";import{u as Yn}from"./use-search-translate-5JG7BMBd.js";import{Dms as Un}from"./index-LiEGpfsO.js";const Gn="_container_17u7d_1",Ln="_form_17u7d_6",Hn="_close_17u7d_23",ke={container:Gn,"form-container":"_form-container_17u7d_6",form:Ln,close:Hn};function Wn({meta:a,relatedViewType:l,record:t,dirty:d=!1,overlay:n,onRefresh:h,onNew:p,onSave:k,onCancel:D}){const{formAtom:w,actionHandler:v,actionExecutor:R,recordHandler:_}=Fs(a,t),{hasButton:V}=zt(a.view,a.perms),O=s.useRef(null),{onSave:U}=a.view,C=(t?.id??-1)<0,g=Os(w),x=Bs(),I=Ys(a,w),r=ce(s.useCallback((B,te)=>{const P=O.current;P&&(O.current=null,te(w,Q=>({...Q,statesByName:P})))},[w]));s.useEffect(()=>{r()},[r]);const u=ce(s.useCallback(async B=>{const te=B(w),P=x(te);if(P){Us(P);return}U&&await R.execute(U);const[Q,Pe]=I();O.current=Gs(a,B(w).statesByName);try{await k?.(Q,Pe)}catch{O.current=null}},[a,w,U,R,x,k,I]));Ie(async()=>{const{onLoad:B,onNew:te}=a.view;if(t){const P=(t?.id??0)>0?B:te;P&&await R.execute(P)}},[t,a.view,R]);const A=s.useRef(null),M=V("new"),le=V("save"),G=V("edit"),q=C?p:h;return Kt({viewType:l,onNew:M?p:void 0,onSave:le?u:void 0,onRefresh:d?q:void 0,onFocus:Ls(A)}),t&&o.jsx(o.Fragment,{children:o.jsxs(b,{d:"flex",flexDirection:"column",flex:1,border:!0,borderBottom:!1,className:ke.container,children:[o.jsxs(b,{d:"flex",w:100,bg:"body",borderBottom:!0,children:[o.jsx(Hs,{items:[{key:"new",text:y.get("New"),hidden:!M,iconProps:{icon:"add"},onClick:p},{key:"save",text:y.get("Save"),hidden:!le||!G,iconProps:{icon:"save"},onClick:u},{key:"back",text:y.get("Back"),iconProps:{icon:"undo"},hidden:n,onClick:D},{key:"refresh",text:y.get("Refresh"),iconProps:{icon:"refresh"},onClick:q,disabled:!d},{...g,disabled:C}],iconOnly:!0}),o.jsx(b,{flex:1,d:"flex",alignItems:"center",justifyContent:"flex-end",className:ke.close,children:o.jsx(b,{d:"flex",p:2,onClick:()=>D?.(),children:o.jsx(tt,{icon:"close"})})})]}),o.jsx(b,{d:"flex",flex:1,className:st(ke["form-container"],{[ke.overlay]:n}),children:o.jsx(b,{d:"flex",flex:1,m:3,bg:"body",className:ke.form,ref:A,children:o.jsx(Ws,{scope:qs,value:a,children:o.jsx(zs,{schema:a.view,fields:a.fields,readonly:!G,formAtom:w,actionHandler:v,actionExecutor:R,recordHandler:_,layout:Ks})})})})]})})}const qn="_container_r9vyt_1",zn="_remove_r9vyt_5",Kn="_icon_r9vyt_12",Qn="_widget_r9vyt_16",Ee={container:qn,remove:zn,icon:Kn,widget:Qn},Je=()=>({field:null,value:null});function Zn(a,l){return s.useMemo(()=>{const t=[],d=(n,h)=>{!n||!(h.massUpdate??n.massUpdate)||/^(id|version|selected|archived|((updated|created)(On|By)))$/.test(n.name)||n.large||n.unique||["BINARY","ONE_TO_MANY","MANY_TO_MANY"].includes(n.type)||t.push({...n,...h,type:n.type,placeholder:h.placeholder??h?.title??n.title})};return Qs(l,n=>{n.type==="field"&&d(a?.[n.name],n)}),t},[a,l])}function Jn({open:a,target:l,fields:t,onUpdate:d,onClose:n}){const h=s.useId(),[p,k]=s.useState([Je()]),[D,w]=s.useState(!1);function v(){if(p.length<t.length){if(![...p].pop()?.field)return;k(g=>[...g,Je()])}}function R(){k([Je()])}function _(C,g,x){k(I=>I.map((r,u)=>u===x?{...r,[C]:g}:r))}function V(C){if(p.length===1)return R();k(g=>g.filter((x,I)=>C!==I))}function O(){const C=p.filter(g=>g.field).reduce((g,x)=>x.field?{...g,[x.field.name]:x.value}:g,{});d?.(C,D)}const U=p.filter(C=>C.field).map(C=>C.field);return o.jsx(Zs,{bg:"body",open:a,target:l,placement:"bottom-start",offset:[0,8],onClose:n,children:o.jsxs(b,{className:Ee.container,bg:"body",p:2,children:[o.jsxs(b,{d:"flex",alignItems:"center",children:[o.jsx(b,{as:"p",mb:0,p:1,flex:1,fontWeight:"bold",children:y.get("Mass Update")}),o.jsx(b,{as:"span",className:Ee.icon,onClick:n,children:o.jsx(tt,{icon:"close"})})]}),o.jsx(Ze,{}),o.jsxs(b,{p:2,py:1,children:[o.jsx(b,{as:"table",w:100,children:o.jsx("tbody",{children:p.map((C,g)=>{const{field:x}=C,I=t.filter(r=>!U.includes(r)||r===x);return o.jsxs("tr",{children:[o.jsx("td",{width:20,className:Ee.remove,onClick:()=>V(g),children:o.jsx(tt,{icon:"close"})}),o.jsx("td",{children:o.jsx(Qt,{multiple:!1,placeholder:y.get("Select"),options:I,optionKey:r=>r.name,optionLabel:r=>r.title??r.autoTitle??r.name,optionEqual:(r,u)=>r.name===u.name,onChange:r=>{_("field",t.find(u=>u.name===r?.name),g)},value:x})}),o.jsx("td",{children:x&&o.jsx(Js,{operator:"=",inputProps:{className:Ee.widget,placeholder:x.placeholder||x.title},field:x,filter:C,onChange:r=>_("value",r?.value??null,g)})})]},g)})})}),o.jsxs(b,{d:"flex",ps:4,mt:2,style:{height:20},children:[o.jsx(b,{children:o.jsx(Tt,{mx:1,onClick:v,children:y.get("Add Field")})}),o.jsx(Ze,{vertical:!0}),o.jsx(b,{children:o.jsx(Tt,{mx:1,onClick:R,children:y.get("Clear")})})]})]}),o.jsx(Ze,{}),o.jsx(b,{p:2,children:o.jsxs(b,{d:"flex",ms:1,children:[o.jsx(Vt,{outline:!0,size:"sm",variant:"primary",disabled:U.length===0,onClick:O,children:y.get("Update")}),o.jsx(Vt,{outline:!0,ms:2,size:"sm",variant:"primary",onClick:n,children:y.get("Cancel")}),o.jsx(b,{d:"flex",ms:2,children:o.jsxs(b,{d:"flex",alignItems:"center",children:[o.jsx(Zt,{id:h,m:0,type:"checkbox",checked:D,onChange:C=>w(!D)}),o.jsx(Xs,{ms:1,mb:0,alignItems:"center",htmlFor:h,children:y.get("Update all")})]})})]})})]})})}const Xn="_container_wvvbq_1",eo="_select_wvvbq_5",Lt={container:Xn,select:eo};function to({column:a,dataAtom:l,onSearch:t}){const d=a,[n,h]=Jt(s.useMemo(()=>Xt(l,w=>w[a.name]??"",(w,v)=>({...w,[a.name]:v})),[a.name,l]));function p(){t?.()}function k(w){h(w.target.value)}function D(w){["Enter","Tab","ArrowRight","ArrowLeft","ArrowUp","ArrowDown"].includes(w.key)&&w.stopPropagation(),w.key==="Enter"&&(w.preventDefault(),p())}if(d.selectionList){const w=d.selectionList.find(v=>v.value===n);return o.jsx(b,{w:100,className:Lt.select,d:"flex",children:o.jsx(Qt,{multiple:!1,value:w??null,placeholder:y.get("Search..."),onChange:v=>{h(v?.value??""),p()},options:d.selectionList,optionKey:v=>v.value,optionLabel:v=>v.title,optionEqual:(v,R)=>v.value===R.value})})}return o.jsx(b,{className:Lt.container,d:"flex",children:o.jsx(Zt,{type:"text",value:n||"",onChange:k,placeholder:y.get("Search..."),onKeyDown:D})})}function so(a){const{column:l}=a;return l.searchable===!1?o.jsx(b,{h:100,w:100}):o.jsx(to,{...a})}function Xe(a,l){return a.add(1,l).startOf(l)}function ot(a){return en({props:a})}function Ht(a){return tn({props:a})}function et(a){return sn({props:a})}function Wt(a,l,t=d=>d){let d=/(<)(.*)(<)(.*)/.exec(a);if(d)return{operator:"between",value:t(d[4],l),value2:t(d[2],l)};if(d=/(<=?|>=?|!?=)(.*)/.exec(a),d){const[,n,h]=d,p=t(h.trim(),l);return{operator:n,value:p}}return{operator:"=",value:t(a,l)}}function qt(a,l){let t="month",d=/M+.+D+/.test(Ht(l)),n=d?"MM/DD":"MM/YYYY",h;return/^\D*\d{4,}\D*$/.test(a)?(n="YYYY",t="year"):/^\D*\d{1,2}\D*$/.test(a)?n="MM":/^\D*\d{4,}\D+\d{1,2}\D*$/.test(a)?n="YYYY/MM":/^\D*\d{1,2}\D+\d{1,2}\D*$/.test(a)?(n=d?"MM/DD":"DD/MM",t="day"):/^\D*\d{1,2}\D+\d{4,}\D*$/.test(a)?n="MM/YYYY":/^\D*\d+\D+\d+\D+\d+\D*$/.test(a)?(n=Ht(l),t="day",h="="):/^\D*\d+\D+\d+\D+\d+\D+\d+\D*$/.test(a)?(n=et(l).replace(/\W+m+$/,""),t="hour"):/^\D*\d+\D+\d+\D+\d+\D+\d+\D+\d+\D*$/.test(a)?(n=et(l),t="minute"):/^\D*\d+\D+\d+\D+\d+\D+\d+\D+\d+\D+\d+\D*$/.test(a)&&(n=et({...l,seconds:!0}),t="second"),[a?ie(a,n):ie(),t,h]}function no(a,l){let t=ot(l),d="minute";return/^\D*\d+\D*$/.test(a)?(t=(t.match(/\w+/)||[])[0]||t,d="hour"):/^\D*\d+\D+\d+\D+\d+\D*$/.test(a)&&(t=ot({seconds:!0}),d="second"),[a?ie(a,t):ie(),d]}function oo(a,l,t){const d=(h,p)=>{const D={...(l||[]).find(_=>_?.name===h?.name),...h};let w=nt(D.type||""),v="like",R={};switch(D.selection&&(w="selection"),w){case"decimal":case"number":case"long":case"integer":R=Wt(p,D,_=>isNaN(_)?0:Number(_));break;case"boolean":v="=",p=!/f|n|false|no|0/.test(p);break;case"many-to-many":case"one-to-many":if(p?.includes?.(" | "))return{operator:"or",criteria:p.split(" | ").filter(_=>_.trim()).map(_=>({fieldName:D.name,operator:"like",value:_}))};break;case"time":case"date":case"datetime":{const V={time:r=>r&&r.format(ot({seconds:!0})),date:r=>r&&r.format("YYYY-MM-DD"),datetime:r=>{const u=r&&r.toDate();return u&&!isNaN(u)&&u instanceof Date?u.toISOString():null}}[w],{operator:O,value:U,value2:C}=Wt(p,D),[g,x,I]=(w==="time"?no:qt)(U,D);if(g){const r=O===I?I:O;switch(r){case"<":case">=":v=r,p=V(ie(g).startOf(x));break;case">":v=">=",p=V(Xe(ie(g),x));break;case"<=":v="<",p=V(Xe(ie(g),x));break;case"=":case"!=":case"between":case"notBetween":{const u=r==="!=";let A=g,M=C?qt(C,D)[0]:A.clone();return A>M&&!u&&([A,M]=[M,A]),A=V(A.startOf(x)),M=V(Xe(M,x)),{operator:u?"or":"and",criteria:[{fieldName:D.name,operator:u?"<":">=",value:A},{fieldName:D.name,operator:u?">=":"<",value:M}]}}}}break}case"enum":case"selection":(D.widget||"").toLowerCase().startsWith("multi")||(v="=");break}return{fieldName:D.name,value:p,operator:v,...R}},n=(h,p)=>{const k={...a[h]||{name:h}};return nt(k.type)==="many-to-one"&&(k.name=`${h}.${k.targetName}`),d(k,p)};return Object.keys(t).filter(h=>t[h]).map(h=>n(h,t[h]))}function ao(a,l,t){return t&&Object.keys(t||{}).length>0?{operator:"and",criteria:oo(a,l,t)}:null}function fo(a){const{action:l}=es();return l.params?.["ui-template:grid"]==="dms-file-list"?o.jsx(Un,{...a}):o.jsx(io,{...a})}function ro({state:a,children:l}){return On(a,{padding:8.125}),l}function co({children:a,state:l,isTreeGrid:t}){const d=s.useMemo(()=>({level:0,eventsAtom:Gt({}),selectAtom:Gt({})}),[]);return t?o.jsx(Vn,{enabled:!0,children:o.jsx($n.Provider,{value:d,children:o.jsx(ro,{state:l,children:a})})}):a}function io(a){const{meta:l,dataStore:t,searchAtom:d}=a,{view:n,perms:h,fields:p}=l,{hasButton:k}=zt(n,h),D=nn(),w=s.useRef(!1),v=s.useRef(null),R=s.useRef([]),_=s.useRef(),V=s.useRef(0),O=s.useRef(!1),U=s.useRef(!1),[C,g]=s.useState(),[x,I]=on(),{action:r,dashlet:u,popup:A,popupOptions:M,state:le}=es(),[G,q]=Jt(an()),[B,te]=s.useState(null),P=rn(),Q=cn(),{isMobile:Pe}=Bn(),{data:at}=ln(),rt=s.useMemo(()=>Xt(d,e=>e.search,(e,c)=>({...e,search:c})),[d]),ts=dn(s.useMemo(()=>un(d,e=>e.fields),[d])),ct=x?.gridState?.selectedRows?.slice?.(0,1),[T,z,Te]=mn({...x?.gridState,view:n,params:r.params,selectedRows:ct});r?.name?.startsWith("$selector");const it=s.useRef((ct?.length??0)>0),[H,ss]=s.useState(t.records),lt=ce(s.useCallback((e,c,{records:i,page:m})=>{const{onGridSearch:f}=M??{};if(f){const{search:j}=(d&&e(d))??{};return f(i,m,j)}return i},[M,d]));s.useEffect(()=>t.subscribe(e=>{ss(lt(e))}),[t,lt]);const ns=fn({view:n,stateAtom:Te,allowCustomization:!!(r.params?.["_can-customize-popup"]??!0)}),{orderBy:se,rows:Y,selectedRows:$,selectedCell:dt}=T,je=r.params?.["dashlet.params"],Ve=r.params?.["details-view"],ne=r.params?.["details-view-mode"]!=="inline",de=!!Ve,$e=r.params?.["grid-width"],Fe=r.params?.popup||r.params?.["dashlet.in.popup"],ut=M?.fullScreen,Oe=s.useRef(!r.params?.["reload-dotted"]),{editable:os,onDelete:Be,inlineHelp:Ye}=n,as=!at?.user?.noHelp&&Ye,mt=pn(r,u),ue=s.useCallback(()=>{z(e=>{e.selectedRows=null,e.selectedCell=null})},[z]),me=hn(),ft=Yn(se,p),fe=ce(s.useCallback((e,c,i={})=>{const{query:m={},search:f}=e(d),j=$t(se),S=ao(p,n.items,f),E={...m};if(S?.criteria?.length&&(E.operator="and",E.criteria=[S,...m.criteria?.length?[{operator:m.operator||"and",criteria:m.criteria}]:[]]),u){const{_domainAction:Qe,...Ae}=me()??{};E._domainContext={...E?._domainContext,...Ae},E._domainAction=Qe}return{translate:ft(E),sortBy:j,...i,filter:E}},[se,d,p,n.items,u,me,ft])),rs=s.useCallback(()=>({...t.options?.filter,...fe().filter}),[t,fe]),pe=s.useCallback((e={})=>t.search(fe(e)),[t,fe]),N=wn(pe),pt=s.useRef(N),{page:cs}=t,{offset:he=0,limit:Z=Fn,totalCount:oe=0}=cs,is=s.useCallback(async(e,c)=>{const i=c?[]:($||[]).map(S=>Y[S]?.record?.id).filter(S=>S>0),m=c?oe:i.length,{model:f}=n;if(m===0)return Me.info({content:c?y.get("There are no records to update."):y.get("Please select at least one record.")});if(await Me.confirm({content:y.get("Do you really want to update all {0} record(s)?",m)})){g(null);let S=r.domain,E={_model:f,...r.context};c||(S?S=S+" AND self.id IN (:__ids__)":S="self.id IN (:__ids__)",E={__ids__:i,...E});const{filter:Se,...Qe}=fe(),Ae=await yn({url:`ws/rest/${f}/updateMass`,method:"POST",body:{data:{...Qe,...Se,_domain:S,_domainContext:E},records:[e]}});if(Ae.ok){const{status:$s}=await Ae.json();if($s!==0)return Promise.reject(500)}N()}},[$,oe,n,Y,r.domain,r.context,fe,N]),ht=s.useCallback((e,c,i=!1)=>{mt({model:n.model,title:(r.params?.forceTitle?r.title:n.title)??"",viewName:(r.views?.find(m=>m.type==="form")||{})?.name,maximize:ut,context:c,record:e,readonly:i,onSearch:()=>N({}),...u&&{params:je}})},[n,r,ut,u,je,mt,N]),wt=s.useCallback((e,c,i=!1)=>{xn({...r,name:Ft("$act"),viewType:"form",params:{...u&&{...je},forceEdit:!i},context:{...c,_showRecord:e.id}})},[r,u,je]),ae=k("edit"),we=os&&ae,Ue=Pe&&we,W=s.useCallback(async(e,c=!1)=>{if(u||Ue){let f={};if(u){const{_domainAction:S,...E}=me()??{};f={...(await gn(S,E,{silent:!0})).context}}const j=r.params?.forceEdit;return Fe||Ue||x?.readonly===!0?ht(e,f,c):wt(e,f,j?!1:c)}const i=e.id||0,m=i>0?String(i):"";Q("form",{route:{id:m},props:{readonly:c}})},[u,Ue,Q,r.params,Fe,x?.readonly,wt,me,ht]),yt=s.useCallback(()=>{W({})},[W]),xt=s.useCallback(()=>{v.current?.onAdd?.()},[]),gt=s.useCallback(e=>{W(e,!0)},[W]),Ge=s.useCallback(async(e,c)=>{const i=Object.keys(l.fields??{}),m=await t.save({...e,...(e.id||-1)<0&&{id:void 0}},{...c,...i.length?{fields:i}:{}});return m&&q(!1),m},[t,l,q]),ls=s.useCallback(()=>{q(!1)},[q]),ds=s.useCallback(()=>{U.current=!0},[]),bt=s.useCallback(async e=>{if(!await Me.confirm({title:y.get("Question"),content:e?y.get("Do you really want to archive the selected record(s)?"):y.get("Do you really want to unarchive the selected record(s)?")}))return;const i=$.map(m=>Y[m]?.record).map(m=>({id:m.id,version:m.version,archived:e}));try{await t.save(i),N(),ue()}catch{}},[Y,$,t,ue,N]),ve=s.useMemo(()=>(r.views?.find(e=>e.type==="form")||{})?.name,[r.views]),{data:J}=Ot(async()=>{if(!de)return null;const e=bn(Ve)?Ve:ve;return await Bt({type:"form",name:e,model:n.model})},[n.model,ve]),F=s.useCallback(async(e,c)=>{if(J&&e&&(e?.id??0)>0){const i=e;e=await vn(J,t,e.id),c&&(e=c(i,e))}q(!1),te(e)},[q,J,t]),us=s.useCallback(async(e,c)=>{const i=await Ge(e);i&&(F(i,c),(e.id??0)<0&&(_.current=i.id))},[Ge,F]),Le=s.useCallback(()=>{P(async()=>G,async()=>{O.current=!1,ue(),F({id:Cn()})})},[G,ue,F,P]),ms=s.useCallback(()=>{P(async()=>G,async()=>F(B))},[F,G,B,P]),fs=s.useCallback(()=>{P(async()=>G,async()=>F(null))},[G,F,P]),_e=($?.length??0)>0&&dt!=null?Y?.[dt[0]]:null,X=_e?.type!=="row"?null:_e?.record,He=($?.length??0)>1,ps=s.useCallback((e,c)=>{X?.id===c?.record?.id&&F(c.record)},[X,F]),hs=s.useCallback((e,c)=>{!e.ctrlKey&&c.record===X&&F(c.record)},[X,F]);Ie(async()=>{if(!J)return;if(He)return F(null);const e=X?.id?X:null;if(e&&it.current){it.current=!1;return}O.current&&F(e),O.current=!0},[He,X?.id,J,t]),Ie(async()=>{r.context?._showSingle&&!x?.showSingle&&H.length===1&&(I(e=>({...e,showSingle:!0})),W(H[0],!0))},[H,W,r]);const ws=he>0,ys=he+Z<oe,vt=1,Ct=Math.ceil(oe/Z),xs=!!$?.length,K=s.useMemo(()=>{if(u)return 0;const e=w.current;return w.current=!0,e||t.records.length===0?+(D?.id||1):Math.floor(he/Z)+1},[t,he,Z,D?.id,u]),ee=s.useCallback(e=>{u||Q("grid",{route:{id:String(e)}})},[u,Q]),gs=s.useCallback(()=>({...me(!0),...R.current?.length>0&&{_ids:R.current},_model:r.model,_viewName:r.name,_viewType:r.viewType,_views:r.views}),[r,me]),ye=s.useMemo(()=>Dn({meta:l,record:{}}),[l]),bs=ce(s.useCallback(async(e,c)=>{const{record:i,dirty:m}=e(ye);if(m){const f=await t.save(i),j={...i,...f,_dirty:void 0};c(ye,S=>({...S,dirty:!1,record:j})),z(S=>{const E=S.rows.find(Se=>Se.record?.id===i.id);E&&(E.record=j)})}},[t,ye,z])),Dt=ce(s.useCallback((e,c)=>{c(ye,i=>{const m=_e?.record??{},f=m._dirty??!1;return{...i,dirty:f,record:m}})},[ye,_e?.record]));s.useEffect(Dt,[Dt]);const xe=Sn(n,{formAtom:ye,getContext:gs,onRefresh:pe,onSave:bs}),vs=kn(),St=Yt(vs),kt=Yt(jn());s.useEffect(()=>{A&&St({data:T,dataRecords:H,dataStore:t,onSearch:N})},[T,H,N,A,t,St]),s.useEffect(()=>{u&&kt({dataStore:t,view:n,actionExecutor:xe,gridStateAtom:Te,onRefresh:()=>pe({})})},[u,n,Te,t,xe,pe,kt]),s.useEffect(()=>{if(A)return;let e=K;he>oe&&(e=Math.ceil(oe/Z)||e),ee(e)},[A,K,Z,he,ee,oe]);const jt=ce(s.useCallback((e,c,i)=>{const m=e(le);c(le,{...m,props:{...m.props,grid:{...m.props?.grid,gridState:i}}})},[le]));s.useEffect(()=>(clearTimeout(V.current),()=>{V.current=window.setTimeout(()=>{jt(T)},100)}),[T,jt]),s.useEffect(()=>{I(e=>{const c=$?Y[$?.[0]]?.record.id:void 0;return e?.selectedId!==c?{selectedId:c}:e})},[I,$,Y]),s.useEffect(()=>{R.current=(T.selectedRows||[]).map(c=>T.rows[c]?.record?.id);const e=_.current;if(e){const c=T.rows?.findIndex(i=>i.record?.id===e);c>0&&z(i=>{i.selectedCell=[c,0],i.selectedRows=[c]})}_.current=null},[T.selectedRows,T.rows,z]),Ie(async()=>{const e=se?.[0]?.name;if(U.current&&e){const c=H.map(f=>f.id),i=Y.filter(f=>c.includes(f.record?.id??0)).map(f=>H.find(j=>j.id===f.record?.id)).map((f,j)=>({id:f?.id,[e]:j+1,version:f?.version??f?.$version})).filter(f=>!e||f[e]!==H.find(j=>j.id===f.id)?.[e]);await t.save(i)&&N()}U.current=!1},[n,Y,H,t,se]);const Cs=s.useMemo(()=>{const e={sortBy:$t(se)};return K?{...e,offset:(K-1)*Z}:e},[se,K,Z]),Ds=s.useCallback(e=>{if(Oe.current&&(Oe.current=!1,Ut(t.options?.fields,e?.fields)))return Promise.resolve({records:t.records,page:t.page});const c=pt.current!==N,i=t.options||{};return!c&&e&&Object.entries(e).every(([m,f])=>Ut(i[m],f))?Oe.current=!1:(pt.current=N)(e)},[N,t]),_t=s.useCallback(e=>pe({offset:0,...e}).then(()=>{t.page?.offset===0&&ee(1)}),[pe,t,ee]),Ss=s.useMemo(()=>e=>o.jsx(so,{...e,dataAtom:rt,onSearch:_t}),[rt,_t]),ks=M?.showToolbar!==!1,js=M?.showEditIcon!==!1&&ae,_s=M?.multiSelect!==!1,Rt={allowSearch:!0,searchRowRenderer:b,searchColumnRenderer:Ss},Rs=!u&&A?{showEditIcon:js,allowSelection:!0,selectionType:_s?"multiple":"single",allowCheckboxSelection:!0}:{},Nt=u?{...r.params?.["dashlet.canSearch"]===!0?Rt:{},readonly:x?.readonly,...Fe&&x?.readonly===!1&&{onView:W}}:{},Ns=de?{...ne&&{onView:void 0},...!B&&!He&&{onRowClick:ne?hs:X?ps:void 0}}:{},As=Nt.readonly,ge=k("new"),We=s.useMemo(()=>de?Le:we?xt:yt,[de,we,Le,xt,yt]),qe=xs&&(!de||!G),At=s.useCallback(()=>{const[e]=$??[],c=Y[e]?.record;c&&W(c)},[$,Y,W]),Ce=k("delete"),Mt=qe,ze=s.useCallback(async e=>{if(await Me.confirm({content:y.get("Do you really want to delete the selected record(s)?"),yesTitle:y.get("Delete")})){Be&&await xe.execute(Be,{context:{_ids:e.map(i=>i.id)}});try{await t.delete(e.map(({id:i,version:m})=>({id:i,version:m}))),ue()}catch{}}},[Be,xe,t,ue]),Et=s.useCallback(()=>{(async()=>await ze($.map(e=>Y[e]?.record)))()},[ze,$,Y]),Ms=s.useCallback(()=>ee(Math.max(vt,K-1)),[K,vt,ee]),Es=s.useCallback(()=>ee(Math.min(Ct,K+1)),[K,Ct,ee]);Kt({viewType:n.type,canHandle:s.useCallback(()=>T.editRow==null,[T.editRow]),onNew:ge?We:void 0,onEdit:ae&&qe?At:void 0,onDelete:Ce&&Mt?Et:void 0,onRefresh:N,onFocus:s.useCallback(()=>{z?.(e=>{const c=e.selectedRows?.[0];if(c!=null){const i=e.selectedCell?.[1]??0;e.selectedCell=[c,i]}else e.selectedCell=[0,0],e.selectedRows=[0]})},[z])}),_n("grid",N);const It=Zn(ts,n.items),Pt=k("edit")&&It.length>0,{treeLimit:Ke,treeField:be,treeFieldTitle:Re}=n,Ne=nt(n.widget??""),Is=Ne==="expandable",re=be&&Ne==="tree-grid",{data:De}=Ot(async()=>{const{summaryView:e,model:c}=n;if(!(!re||!e))return await Bt({type:"form",name:e,model:c})},[re,n]),Ps=s.useMemo(()=>{const{model:e}=n,c=l.fields?.[be];if(re){const i=De?.fields??{},m=Object.keys(i).reduce((j,S)=>De&&Rn(De,S)?{...j,[S]:i[S]}:j,{}),f={type:"ONE_TO_MANY",...c,target:e,name:be,title:Re&&y.get(Re)||y.get("Add subitem")};return{model:e,fields:{...m,[be]:f},view:{type:"form",model:e,items:[{...f,editable:we,colSpan:12,canNew:ge,canEdit:ae,canRemove:Ce,canView:!0,editIcon:!0,onDelete:n.onDelete,onNew:n.onNew,onSave:n.onSave,summaryView:n.summaryView,fields:l.fields,items:n.items,uid:Ft("w"),type:"panel-related",formView:ve,widget:Ne,widgetAttrs:{treeField:be,treeFieldTitle:Re,...Ke&&{treeLimit:Ke-1}},serverType:f.type,[Nn]:!1},...(De?.view?.items??[]).filter(j=>j.name!=="$wkfStatus")],width:"*"}}}return n.summaryView??ve},[De,n,we,ve,l,Ne,ge,ae,Ce,re,Ke,be,Re]),Ts=J&&!ne&&$e?{minWidth:$e,maxWidth:$e}:void 0,Vs=s.useMemo(()=>({type:"grid",newIcon:!1}),[]);return o.jsxs("div",{className:L.container,children:[ks&&o.jsx(An,{meta:l,actions:[{key:"new",text:y.get("New"),hidden:!ge,iconProps:{icon:"add"},onClick:We},{key:"edit",text:y.get("Edit"),hidden:!ae,iconProps:{icon:"edit"},disabled:!qe,className:Mn("hide-sm"),onClick:At},{key:"massUpdate",iconOnly:!0,iconProps:{icon:"arrow_drop_down"},className:st(L["mass-update"],{[L.active]:!!C}),onClick:e=>g(e.target),hidden:!Pt},{key:"delete",text:y.get("Delete"),hidden:!Ce,iconProps:{icon:"delete"},disabled:!Mt,onClick:Et,items:k("archive")?[{key:"archive",text:y.get("Archive"),onClick:()=>bt(!0)},{key:"unarchive",text:y.get("Unarchive"),onClick:()=>bt(!1)}]:void 0},{key:"refresh",text:y.get("Refresh"),iconProps:{icon:"refresh"},onClick:()=>N()}],dataStore:t,getActionData:rs,actionExecutor:xe,pagination:{canPrev:ws,canNext:ys,onPrev:Ms,onNext:Es,text:()=>o.jsx(En,{dataStore:t})},children:d&&o.jsx(In,{stateAtom:d,dataStore:t,items:T.columns,customSearch:n.customSearch,freeSearch:n.freeSearch,onSearch:N})}),as&&o.jsx("div",{className:L.help,children:o.jsx(Pn,{text:Ye.text,css:Ye.css})}),o.jsxs("div",{className:L.views,children:[o.jsxs("div",{className:L["grid-view"],style:Ts,children:[o.jsx(co,{state:T,isTreeGrid:!!re,children:o.jsx(Tn,{className:L.grid,ref:v,records:H,view:n,fields:p,perms:h,state:T,setState:z,sortType:"live",editable:u||r?.name?.startsWith("$selector")?!1:we,...(Is||re)&&{gridContext:Vs,showAsTree:re,showNewIcon:ge,showDeleteIcon:Ce,expandable:!0,expandableView:Ps,onNew:We,onDelete:ze},showEditIcon:ae,searchOptions:Cs,searchAtom:d,actionExecutor:xe,onEdit:As===!0?gt:W,onView:gt,onSearch:Ds,onSave:Ge,onDiscard:ls,onRowReorder:ds,noRecordsText:y.get("No records found."),onColumnCustomize:ns,...u?{}:Rt,...Nt,...Rs,...Ns,...!ge&&{onRecordAdd:void 0}})}),de&&G&&o.jsx(b,{bg:"light",className:L.overlay})]}),J&&o.jsx(b,{bg:"body",className:st(L["details-view"],{[L["details-view-overlay"]]:ne,[L.hide]:!B}),...ne&&B&&{shadow:"2xl",dropShadow:"2xl"},children:B?o.jsx(Wn,{relatedViewType:n.type,dirty:G,overlay:ne,meta:J,record:B,onNew:Le,onRefresh:ms,onSave:us,onCancel:fs}):!ne&&o.jsx(b,{d:"flex",flex:1,justifyContent:"center",alignItems:"center",border:!0,borderBottom:!1,children:o.jsx(b,{as:"span",children:y.get("Either select or create a record.")})})}),Pt&&o.jsx(Jn,{open:!!C,target:C,fields:It,onUpdate:is,onClose:()=>g(null)})]})]})}export{fo as Grid};
