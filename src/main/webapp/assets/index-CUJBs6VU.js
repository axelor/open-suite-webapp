import{ad as U,r as c,ae as J,af as he,j as s,ag as pe,B as m,ah as le,D as E,ai as ee,aj as xe,ak as ne,a4 as ye,h as we,al as je,am as be,an as ge,U as P,ao as Ce,ap as ve,aq as _e,ar as oe,as as ce,at as Ee,au as Se,av as ke,W as Ae,Z as Ne,v as Ve,aw as Te,a8 as Fe,ax as Me}from"./index-Hj3ihs7h.js";import{f as $e,p as Oe,a as Le,b as Ie,s as Re}from"./utils-BNR0zjDD.js";const qe="_select_pr0cv_24",L={"search-objects":"_search-objects_pr0cv_1","search-section":"_search-section_pr0cv_9","actions-section":"_actions-section_pr0cv_10",select:qe};function se({value:y,parent:v,actionMenus:g,...R}){const f=v?.name,q=c.useCallback(async()=>{const j=g?.filter(u=>u.parent===f)??[],b=await $e(f)??[];return[...j,...b]},[g,f]);return s.jsx(le,{...R,options:[],value:y??null,optionKey:j=>j.name,optionLabel:j=>j.title,optionEqual:(j,b)=>j.name===b.name,fetchOptions:q},f)}function De({stateAtom:y,selects:v=[],actionMenus:g,hasActions:R=!0,onSearch:f,onClear:q,onGo:j}){const[b,u]=U(c.useMemo(()=>J(y,e=>e.selectValue,(e,t)=>({...e,selectValue:t})),[y])),[D,x]=U(c.useMemo(()=>J(y,e=>e.actionCategory,(e,t)=>({...e,actionCategory:t})),[y])),[V,S]=U(c.useMemo(()=>J(y,e=>e.actionSubCategory,(e,t)=>({...e,actionSubCategory:t})),[y])),[T,_]=U(c.useMemo(()=>J(y,e=>e.action,(e,t)=>({...e,action:t})),[y])),[Z]=he(),k=c.useCallback(e=>{x(e),S(null),_(null)},[x,S,_]),G=c.useCallback(e=>{S(e),_(null)},[S,_]),W=c.useCallback(e=>{_(e)},[_]);function Q(){u((v||[]).filter(e=>e.selected)),x(null),S(null),_(null),q?.()}const A=c.useCallback(({option:e})=>s.jsx(pe,{title:s.jsx("span",{children:e?.title}),color:"primary",onRemove:()=>{Array.isArray(b)&&u(b.filter(t=>t.model!==e.model))}}),[b,u]),F=Z.get("objects");return c.useEffect(()=>{if(F){const e=F.split(",");u(e.map(t=>v?.find(X=>X.model===t)).filter(t=>t))}else u((v||[]).filter(e=>e.selected))},[F,v,u]),s.jsxs(m,{className:L["search-objects"],d:"flex",p:3,my:2,border:!0,rounded:!0,children:[s.jsx(m,{d:"flex",flex:1,children:s.jsxs(m,{className:L["search-section"],children:[s.jsx(m,{d:"flex",className:L.select,w:100,children:s.jsx(le,{multiple:!0,placeholder:E.get("Search Objects"),options:v,optionLabel:e=>e.title,optionKey:e=>e.model,optionEqual:(e,t)=>e.model===t.model,value:b,onChange:e=>{u(e)},renderValue:A})}),s.jsx(m,{d:"flex",children:s.jsx(ee,{variant:"primary",w:100,onClick:()=>f(),children:E.get("Search")})}),s.jsx(m,{d:"flex",children:s.jsx(ee,{variant:"primary",w:100,onClick:()=>Q(),children:E.get("Clear")})})]})}),R&&s.jsx(m,{d:"flex",flex:1,children:s.jsxs(m,{className:L["actions-section"],children:[s.jsx(m,{d:"flex",className:L.select,children:s.jsx(se,{actionMenus:g,placeholder:E.get("Action Category"),value:D,onChange:e=>k(e)})}),s.jsx(m,{d:"flex",className:L.select,children:D&&s.jsx(se,{actionMenus:g,placeholder:E.get("Action Sub-Category"),parent:D,value:V,onChange:e=>G(e)})}),s.jsx(m,{d:"flex",className:L.select,children:V&&s.jsx(se,{actionMenus:g,placeholder:E.get("Action"),parent:V,value:T,onChange:e=>W(e)})}),s.jsx(m,{d:"flex",children:s.jsx(ee,{variant:"primary",w:100,onClick:j,children:E.get("Go")})})]})})]})}const Ge="_container_1arrw_1",Be={container:Ge};function Pe(y){const v=xe(),g=c.useMemo(()=>ne([]),[]),[R,f]=U(g),[q,j,b]=ye(),u=c.useMemo(()=>ne({selectValue:[],actionCategory:null,actionSubCategory:null,action:null}),[]),D=c.useRef({}).current,{meta:x}=y,{view:V}=x,{name:S,selects:T,actionMenus:_,limit:Z=Me}=V,{action:k}=we(),{params:G}=k,W=(v.search||"").slice(1),Q=c.useCallback(()=>({...k.context,_viewName:k.name,_viewType:k.viewType,_views:k.views}),[k]),{formMeta:A,formView:F}=c.useMemo(()=>{const{searchForm:n}=x,d=x.model||x.view.selects?.find(i=>i.model)?.model,l=Oe({...x,model:d}),a=je(n);if(a){const i={fields:l.fields,view:a};be(i,a),Le(a)}return{formMeta:a?.items?{...l,view:{...l.view,items:a?.items}}:l,formView:a}},[x]),e=c.useMemo(()=>{const{name:n,hilites:d,buttons:l,resultFields:a}=V,i=Ie(a),o=[...Object.values(i)||[]],h=o?.findIndex(C=>C.name==="object"),r={title:E.get("Object"),name:"_modelTitle"};return o[h]?o[h]={...o[h],...r,...+(o[h]?.width??-1)==0&&{hidden:!0}}:o?.unshift(r),{name:n,type:"grid",hilites:d,items:[...o||[],...l||[]].filter(C=>C.hidden!==!0)}},[V]),{formAtom:t,actionHandler:X,actionExecutor:Y,recordHandler:re}=ge(A,D),I=c.useCallback(n=>{if(F){const d=F[n];return d&&Y.execute(d)}},[F,Y]),B=P(c.useCallback((n,d,l,a=!1)=>{const{$$id:i,_model:o,_modelTitle:h,_form:r,_grid:C}=l;if(!o)return;const $=T?.find(N=>N.model===o)?.viewTitle,O=n(g).filter(N=>N._model===o).map(N=>N.$$id).join(","),H=($?(Ce($)?ve($):_e($))({...l,id:i}):"")||h;oe({title:H,model:o,name:ce("$act"),viewType:"form",views:[{type:"grid",name:C},{type:"form",name:r}],params:{forceEdit:!a,forceTitle:!0},context:{_showRecord:i},...O&&{domain:`self.id IN (${O})`}})},[g,T])),ie=c.useCallback(n=>B(n,!0),[B]),M=P(c.useCallback(async(n,d,l)=>{const{record:a}=n(t),{selectValue:i}=n(u);if(!Object.values(a).some(r=>r)){f(r=>r.length?[]:r);return}const h=(await Re({data:{...a,__name:S,__selected:i?.length?i.map(r=>r.model):null},limit:Z})).map((r,C)=>(T?.find(w=>w.model===r._model)?.fields?.forEach(w=>{w.as&&w.selectionList&&r[w.as]&&(r[w.as]=r[w.as].split(/\s*,\s*/).map(O=>w.selectionList?.find(H=>`${H.value}`==`${O}`)?.title??O).join(", "))}),{...r,$$id:r.id,id:C+1}));f(h),h.length===0?Ee.info({message:E.get("No records found.")}):l?.showSingle&&h.length===1&&B(h[0],!l?.forceEdit),I("onLoad")},[t,u,f,T,S,Z,B,I])),de=P(c.useCallback((n,d)=>{d(t,{...n(t),record:{},dirty:!1}),f([]),I("onNew")},[t,f,I])),ue=P(c.useCallback(async n=>{const{action:d}=n(u),{record:l}=n(t),a=d?.action;if(a){const{rows:i,selectedRows:o}=n(b),h=i?.[o?.[0]??-1]?.record,r=(()=>{const $=Object.keys(l).reduce((p,K)=>{const z=l[K];return z===null?p:{...p,[K]:z}},{}),w=(o??[]).map(p=>i[p]).filter(p=>p.type==="row").map(p=>p.record).reduce((p,{_model:K,id:z})=>({...p,[K]:[...p[K]??[],z]}),{}),O=Object.keys(w).map(p=>({model:p,ids:w[p]})),{model:H,view:{name:N,type:ae}}=x;return{...$,_results:O,_model:H,_action:a,_source:"go",_viewName:N,_viewType:ae,_views:[{name:N,type:ae}]}})(),C=await Se(a,{_searchContext:r});oe({...C,name:ce("$act"),viewType:"form",...h&&{domain:`self.id IN (${h.id})`},context:{...C.context,_searchContext:r}})}},[x,b,u,t])),te=P(c.useCallback((n,d,l)=>{const a=n(t);ke(a.record,l)||(d(t,{...a,record:l,dirty:!1}),f([]),M(G))},[t,G,f,M])),me=c.useCallback(n=>{n.key==="Enter"&&!n.defaultPrevented&&M()},[M]),fe=Ae(e,{getContext:Q,onRefresh:M});return c.useEffect(()=>{const n=W?.split("&").reduce((l,a)=>{let[i,o]=a.split("=");return{...l,[i]:o}},{}),d=Object.keys(A.fields||{}).reduce((l,a)=>{const i=A.fields?.[a];let o=n[a];return o?(i?.targetName&&(isNaN(o)?o=null:o={id:o}),{...l,[a]:o}):l},{});te(d)},[W,A,te]),Ne(async()=>{I("onNew")},[I]),Ve("search",M),s.jsxs(m,{d:"flex",flexDirection:"column",flex:1,p:2,className:Be.container,children:[s.jsx(m,{onKeyDown:me,children:s.jsx(Te,{schema:A.view,fields:A.fields,readonly:!1,formAtom:t,actionHandler:X,actionExecutor:Y,recordHandler:re})}),s.jsx(De,{hasActions:!G?.hideActions,selects:T,actionMenus:_,stateAtom:u,onGo:ue,onSearch:M,onClear:de}),s.jsx(m,{d:"flex",flex:1,children:s.jsx(Fe,{showEditIcon:!0,readonly:!1,records:R,view:e,fields:x.fields,state:q,setState:j,actionExecutor:fe,onEdit:B,onView:ie})})]})}export{Pe as Search};
