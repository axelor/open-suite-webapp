import{ck as bt,cl as kt,r,j as t,B as u,E as W,aS as F,D as l,F as Ie,z as Oe,ai as St,J as ie,aE as Ct,bc as Dt,an as jt,k as Be,b5 as Nt,U as we,aw as vt,cm as Tt,bG as Le,cn as Et,co as At,cp as Rt,cq as It,ak as Mt,b8 as ze,av as Ft,cr as $t,cs as Pt,ct as Ht,a as Ge,cu as qt,a6 as Ot,at as Bt,h as Lt,b7 as zt,Q as Gt,cv as Ut,cw as Xt,cx as Vt,_ as Jt,x as Kt,a4 as Wt,aJ as Yt,H as be,cy as Qt,X as Zt,v as es,cz as ts,aL as ss,a0 as ns,a1 as os,a2 as rs,aT as as,a_ as Ue,a8 as cs,bK as is,cA as Me,a3 as ls}from"./index-tEJzJsUq.js";function ds(a){const s=bt().getMonitor(),[o,d]=kt(s,a);return r.useEffect(()=>s.subscribeToOffsetChange(d)),r.useEffect(()=>s.subscribeToStateChange(d)),o}const us="_drawer_11g4i_1",ms="_show_11g4i_10",fs="_title_11g4i_15",ps="_close_11g4i_22",hs="_link_11g4i_23",gs="_icon_11g4i_24",xs="_tagsForm_11g4i_28",P={drawer:us,show:ms,title:fs,close:ps,link:hs,icon:gs,tagsForm:xs},ys="dms-file-tags-form",_s=r.memo(function({open:e,model:s,data:o,onSave:d,onView:m,onClose:f}){const[x,g]=r.useState(!1),{fileName:p,createdBy:S,createdOn:N,updatedOn:D,isDirectory:j,tags:h}=o||{},w=r.useCallback(()=>{g(!0)},[]),T=r.useCallback(E=>{g(!1),d?.(E)},[d]);r.useEffect(()=>{o&&g(!1)},[o]);function O(E,de){return t.jsxs(u,{children:[t.jsx(u,{as:"label",mb:1,color:"secondary",children:E}),t.jsx(Tt,{value:de})]})}return t.jsx(u,{className:W(P.drawer,{[P.show]:e&&o}),shadow:!0,borderTop:!0,bgColor:"body",children:o&&t.jsxs(t.Fragment,{children:[t.jsxs(u,{p:2,d:"flex",alignItems:"center",children:[t.jsx(u,{className:P.title,flex:1,m:0,children:t.jsx(u,{as:"span",fontWeight:"bold",children:p})}),t.jsx(F,{className:P.close,icon:"close",onClick:f})]}),t.jsxs(u,{p:2,children:[O(l.get("Type"),j?l.get("Directory"):l.get("File")),O(l.get("Owner"),S?.name),O(l.get("Created"),Ie.datetime(N)),O(l.get("Modified"),Ie.datetime(D))]}),t.jsx(u,{d:"flex",mt:2,px:1,children:x?t.jsx(u,{flex:1,className:P.tagsForm,children:t.jsx(ws,{model:s,record:o,onSave:T})}):h?.length>0?t.jsx(t.Fragment,{children:t.jsxs(u,{d:"flex",flexWrap:"wrap",children:[h?.map?.(E=>t.jsx(u,{ms:1,mt:1,className:Oe("label",E.style),children:E.name},E.id)),t.jsx(u,{d:"flex",ms:1,mt:1,alignItems:"center",className:P.icon,title:l.get("Edit"),onClick:w,children:t.jsx(F,{icon:"edit",fill:!0,fontSize:"1rem"})})]})}):t.jsx(u,{children:t.jsx(St,{size:"sm",variant:"link",onClick:w,children:l.get("Add some tags")})})}),t.jsx(u,{py:3,px:2,children:t.jsx(ie,{className:P.link,onClick:()=>m?.(o),children:l.get("More details...")})})]})})});function ws({model:a,record:e,onSave:s}){const{data:o}=Ct(async()=>await Dt({type:"form",name:ys,model:a}),[a]);return o&&t.jsx(bs,{meta:o,record:e,onSave:s})}function bs({meta:a,record:e,onSave:s}){const{formAtom:o,actionHandler:d,actionExecutor:m,recordHandler:f}=jt(a,e),x=Be(Nt()),g=we(r.useCallback(async p=>{const{record:S}=p(o),{id:N,version:D,tags:j}=S;s({id:N,version:D,tags:j}),x(!1)},[o,s,x]));return r.useEffect(()=>()=>{x(!1)},[x]),t.jsxs(t.Fragment,{children:[t.jsx(vt,{schema:a.view,fields:a.fields,readonly:!1,formAtom:o,actionHandler:d,actionExecutor:m,recordHandler:f}),t.jsx(u,{px:1,d:"flex",alignItems:"center",children:t.jsx(F,{icon:"check",fill:!0,className:P.icon,onClick:g})})]})}const ks="_container_1257s_1",Ss="_content_1257s_14",Fe={container:ks,content:Ss};function Cs({children:a,className:e,onUpload:s}){const[{canDrop:o,isOver:d},m]=Le({accept:[Et],drop(x,g){const p=g.getItem().files;s?.(p)},collect:x=>({isOver:x.isOver(),canDrop:x.canDrop()})}),f=o&&d;return t.jsxs(u,{ref:m,className:e,children:[f&&t.jsx(u,{className:Fe.container,children:t.jsxs(u,{className:Fe.content,d:"flex",flexDirection:"column",bgColor:"body",border:!0,children:[t.jsx(u,{children:t.jsx(F,{fontSize:"2.5rem",icon:"upload"})}),t.jsx(u,{textAlign:"center",children:l.get("Drop your files to start upload.")})]})}),a]})}const le="DMS_NODE_TYPE",Xe=At({}),Ds=It((a,e)=>Mt(e(Xe)));function Ve(){return Rt(Ds)}const js="_list_6mkwk_1",Ns="_node_6mkwk_17",vs="_hovered_6mkwk_28",Ts="_active_6mkwk_31",Es="_icon_6mkwk_36",As="_hide_6mkwk_36",G={list:js,node:Ns,hovered:vs,active:Ts,icon:Es,hide:As},Rs=r.memo(function({data:e,onDrop:s,onSelect:o,onExpand:d}){const{getSelectedDocuments:m}=ze(Ve()),[{hovered:f},x]=Le({accept:le,drop({data:{record:g}}){const p=m?.()??[];p.some(S=>S.id===g.id)||p.push(g),s?.(e,p)},canDrop(g){const{data:{record:p}}=g;return p?.["parent.id"]!==e.id&&p?.id!==e.id},collect:function(g){return{hovered:g.isOver({shallow:!0})&&g.canDrop()}}});return t.jsxs(u,{as:"li",children:[t.jsxs(u,{ref:x,d:"flex",as:"span",className:W(G.node,{[G.active]:e._selected,[G.hovered]:f}),style:{paddingLeft:`${(e._level??0)*.75}rem`},onClick:()=>o?.(e),children:[t.jsx(F,{icon:e._expand?"arrow_drop_down":"arrow_right",className:W(G.icon,{[G.hide]:!e._children}),...e._children&&{onClick:g=>{g.preventDefault(),g.stopPropagation(),d?.(e)}}}),t.jsx(F,{icon:"folder",fill:!0}),t.jsx(u,{as:"span",mx:2,title:e.fileName,children:e.fileName})]}),e._children&&e._expand&&t.jsx(Je,{data:e._children,onDrop:s,onSelect:o,onExpand:d})]})}),Je=r.memo(function({data:e=[],onDrop:s,onSelect:o,onExpand:d}){return t.jsx(u,{as:"ul",flexGrow:1,className:G.list,children:e.map((m,f)=>t.jsx(r.Fragment,{children:t.jsx(Rs,{data:m,onDrop:s,onSelect:o,onExpand:d})},m.id??`ROOT_${f}`))})}),Is=r.memo(function({data:e,root:s,selected:o,expanded:d,...m}){const f=r.useRef({}),x=r.useMemo(()=>{function g(p,S=0){const N=e.filter(h=>h["parent.id"]===p.id).map(h=>g(h,S+1)),D={...p,_level:S,_selected:o===p.id,_expand:d?.includes(p.id),...N.length&&{_children:N}},j=f.current[p.id];return j&&Ft(D,j)?j:f.current[p.id]=D}return e.filter(p=>p.id===s.id).map(g)},[e,s,o,d]);return t.jsx(Je,{...m,data:x})}),Ms="_container_8uoqa_1",Fs="_title_8uoqa_9",$s="_item_8uoqa_13",Ps="_name_8uoqa_17",Hs="_progress_8uoqa_21",qs="_actions_8uoqa_24",Os="_close_8uoqa_31",q={container:Ms,title:Fs,item:$s,name:Ps,progress:Hs,actions:qs,close:Os};function Bs({uploader:a}){const[,e]=r.useReducer(()=>({}),{});return r.useEffect(()=>a.subscribe(e),[a]),a.items.length>0&&t.jsxs(u,{border:!0,rounded:!0,className:q.container,bgColor:"body",children:[t.jsxs(u,{d:"flex",px:3,py:2,className:q.title,children:[t.jsx(u,{flex:1,children:a.running?l.get("Uploading files..."):l.get("Upload complete")}),t.jsx(u,{d:"flex",className:q.close,children:!a.running&&t.jsx(F,{onClick:()=>a.finish(),icon:"close"})})]}),t.jsx(u,{borderTop:!0,children:a.items.map((s,o)=>t.jsxs(u,{d:"flex",className:q.item,borderBottom:!0,p:1,children:[t.jsx(u,{className:q.name,children:s.file?.name}),t.jsx(u,{className:q.progress,d:"flex",alignItems:"center",px:1,children:t.jsx($t,{value:s.progress??0,schema:{colors:"g:100"}})}),!s.loaded&&t.jsx(u,{className:q.actions,children:s.pending?t.jsx(ie,{onClick:()=>s?.abort?.(),children:l.get("Cancel")}):t.jsx(ie,{onClick:()=>s?.retry?.(),children:l.get("Retry")})})]},o))})]})}const Ls="_container_1hmwh_1",zs="_preview_1hmwh_11",Gs="_badge_1hmwh_21",ke={container:Ls,preview:zs,badge:Gs};function Us(a){if(!a)return{display:"none"};const{x:e,y:s}=a,o=`translate(${e-5}px, ${s-5}px)`;return{transform:o,WebkitTransform:o}}function Xs({record:a}){const{getSelectedDocuments:e}=ze(Ve()),o=r.useMemo(()=>{const d=e?.();return d?.some(m=>m.id===a?.id)?d:[...d??[],a]},[e,a])?.length;return t.jsxs(u,{children:[a?.fileName,o>1&&t.jsx(Pt,{as:"span",className:ke.badge,rounded:!0,bg:"danger",children:o})]})}const Vs=()=>{const{itemType:a,isDragging:e,item:s,offset:o}=ds(f=>({item:f.getItem(),itemType:f.getItemType(),offset:f.getClientOffset(),isDragging:f.isDragging()}));function d(){switch(a){case le:return t.jsx(Xs,{record:s?.data?.record});default:return null}}if(!e)return null;const m=Us(o);return t.jsx("div",{className:ke.container,children:t.jsx(u,{className:ke.preview,bgColor:"body",shadow:"sm",style:m,children:d()})})};function $e(a){try{return JSON.parse(a)}catch{return null}}function Pe(a,e){function s(o){return o>1e9?parseFloat(String(o/1e9)).toFixed(2)+" GB":o>1e6?parseFloat(String(o/1e6)).toFixed(2)+" MB":o>=1e3?parseFloat(String(o/1e3)).toFixed(2)+" KB":o+" B"}return s(a||0)+"/"+s(e)}class Js{#t=[];#s=[];#e=!1;#o=null;#n=new Set;get running(){return this.#e}get items(){return this.#t}setSaveHandler(e){this.#o=e}subscribe(e){return this.#n.add(e),()=>{this.#n.delete(e)}}notify(){this.#n.forEach(e=>e())}queue(e){e.pending=!0,e.progress=0,e.transfer=l.get("Pending"),e.abort=()=>{e.transfer=l.get("Cancelled"),e.pending=!1,this.notify()},e.retry=()=>{this.queue(e),this.process(),this.notify()},this.#t.includes(e)||this.#t.push(e),this.#s.includes(e)||this.#s.push(e),this.notify()}process(){if(this.#e||this.#s.length===0)return this.#t.every(m=>m.complete)&&(this.#t.length=0),this.notify();this.#e=!0,this.notify();let e=this.#s.shift();for(;e&&!e.pending;)e=this.#s.shift();if(!e){this.#e=!1,this.notify();return}const s=this.upload(e),o=m=>(this.#e=!1,e&&(e.active=!1,e.pending=!1,e.progress=0,e.transfer=m.message,e.failed=!0,this.notify()),this.process()),d=()=>(this.#e=!1,e&&(e.active=!1,e.pending=!1,e.complete=!0,e.progress=100,this.notify()),this.process());return s.then(d,o)}finish(){this.#e=!1,this.#t.length=0,this.#s.length=0,this.notify()}async upload(e){const s=new XMLHttpRequest,o=e.file,d=this.#o,m=()=>this.notify();return new Promise((f,x)=>{function g(){return Ge({url:"ws/files/upload/"+e.uuid,method:"DELETE"})}function p(h){function w(){const T=h&&h.error?h.error:l.get("Failed");x({message:T,failed:!0})}g().then(w,w)}function S(h){function w(){x({message:l.get("Cancelled"),cancelled:!0})}return h?g().then(w,w):w()}function N(h){const w={fileName:h.fileName,metaFile:qt(h,"id")};return d?d(w).then(f,p):f(w)}function D(h){if(e._start=e._end,e._end=Math.min((e._end??0)+(e._size??0),o.size),h&&h.fileId&&(e.uuid=h.fileId),m(),h&&h.id)return N(h);if(e.loaded)return p();j()}function j(){s.open("POST","ws/files/upload",!0),s.overrideMimeType("application/octet-stream"),s.setRequestHeader("Content-Type","application/octet-stream"),s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.setRequestHeader("X-CSRF-Token",Ht("CSRF-TOKEN")),e.uuid&&s.setRequestHeader("X-File-Id",e.uuid),s.setRequestHeader("X-File-Name",encodeURIComponent(o.name)),s.setRequestHeader("X-File-Type",o.type),s.setRequestHeader("X-File-Size",String(o.size)),s.setRequestHeader("X-File-Offset",String(e._start)),e._end>o.size&&(e._end=o.size,m());const h=o.slice(e._start,e._end);s.send(h)}e.uuid=null,e._start=0,e._size=1e3*1e3,e._end=e._size,e.active=!0,e.transfer=Pe(0,o.size),e.abort=function(){s.abort(),S(),m()},e.retry=()=>{this.queue(e),this.process()},m(),s.upload.addEventListener("progress",function(h){const w=(e._start??0)+h.loaded,T=Math.round(w/o.size*100);e.progress=T>95?95:T,e.transfer=Pe(w,o.size),e.loaded=w===o.size,m()}),s.onreadystatechange=function(h){if(s.readyState===4)switch(s.status){case 0:case 406:S(!0);break;case 200:D(s.responseText?$e(s.responseText):null);break;default:p(s.responseText?$e(s.responseText):null)}},j()})}}const K={HTML:"html",SPREADSHEET:"spreadsheet"},Ks=(a,e)=>`<strong>${e?`<em>${a}</em>`:a}</strong>`;function Ws({model:a},e){const s=e.contentType===K.SPREADSHEET,o=s?{name:`spreadsheet?id=${e.id}`,type:"html"}:{name:"dms-html-form",type:"form",width:"large",items:[{type:"panel",items:[{type:"panel",items:[{type:"button",title:l.get("Save"),icon:"save",onClick:"save",colSpan:"3"},{type:"button",title:l.get("Download"),icon:"download",onClick:"save,action-dms-file-download",colSpan:"3"}]},{type:"field",name:"content",showTitle:!1,widget:e.contentType||"html",colSpan:12,height:520}]}]};return{name:`$act:dms${e.id}`,model:a,title:s?l.get("Spreadsheet"):l.get("Document"),viewType:o.type,views:[o],params:{"show-toolbar":!1,forceEdit:!0},context:{_showRecord:e?.id}}}async function He(a,e="com.axelor.dms.db.DMSFile"){const s=await Ge({url:"ws/dms/download/batch",method:"POST",body:{model:e,records:[a.id]}});if(s.ok){const{batchId:o,batchName:d}=await s.json();if(o||d)return Ot(`ws/dms/download/${o}?fileName=${d}`,d)}else Bt.error({message:l.get("Some files can't be downloaded. Please check them and retry.")})}const Ys="_container_1p0x0_1",Qs="_content_1p0x0_9",Zs="_grid_1p0x0_15",en="_tree_1p0x0_26",tn="_hide_1p0x0_41",sn="_toolbar_1p0x0_51",nn="_breadcrumbs_1p0x0_56",on="_popup_1p0x0_77",$={container:Ys,content:Qs,grid:Zs,tree:en,hide:tn,toolbar:sn,breadcrumbs:nn,popup:on},rn=-1,qe=async(a,e="",s)=>await be.confirm({title:a,content:t.jsx(u,{d:"flex",w:100,children:t.jsx(Ue,{type:"text",autoFocus:!0,defaultValue:e,onChange:d=>{e=d.target.value}})}),yesTitle:s??l.get("Create")})&&e;function dn(a){const{meta:e,dataStore:s,searchAtom:o}=a,{view:d,fields:m}=e,{action:f,popup:x,popupOptions:g}=Lt(),{data:p}=zt(),{hasButton:S}=Gt(e.view,e.perms),{open:N}=Ut(),{navigate:D}=Xt(),j=Vt(),h=Be(Jt()),w=Kt(),T=f.params?.["_popup-record"],O=r.useMemo(()=>T??{id:null,fileName:l.get("DMS.Home")},[T]),[E,de]=Wt(),[b,We]=r.useState(O),[ue,Y]=r.useState(null),[me,Q]=r.useState(!1),Se=r.useRef(null),Ce=r.useRef(null),[U,X]=r.useState([b]),[Ye,De]=r.useState([b.id]),[v,fe]=r.useState(b.id),[Qe,Ze]=r.useState(void 0),{orderBy:je,rows:Z,selectedRows:B}=E,ee=p?.data?.upload?.maxSize??0,L=r.useMemo(()=>new Js,[]),{relatedId:te,relatedModel:se}=T||{},A=r.useCallback(()=>U.find(n=>n.id===v),[U,v]),R=r.useCallback(()=>{const n=B?.[0];return Z[n??-1]?.record},[Z,B]),V=r.useCallback(()=>{const n=B?.map?.(c=>Z[c]?.record);return n?.length?n:null},[Z,B]),Ne=r.useCallback(()=>R()||A(),[R,A]),pe=p?.features?.dmsSpreadsheet,H=r.useCallback(n=>{if([...pe?[K.SPREADSHEET]:[],K.HTML].includes(n.contentType)?N(Ws(d,n)):D(`/ds/dms.file/edit/${n.id}`),x){let i=Ce?.current?.parentElement;for(;i&&i?.parentElement!==document.body;)i=i?.parentElement;i?.querySelector?.("[data-popup-close]")?.click?.()}},[pe,x,N,d,D]),ne=r.useCallback(({parent:n})=>{if(n&&b.id===rn)return We(c=>({...c,...n})),X(c=>c.map(i=>i.id===b.id?{...i,...n}:i)),fe(c=>c===b.id?n.id:c),De(c=>c.map(i=>i===b.id?n.id:i)),!0},[b]),oe=r.useCallback(n=>{fe(n.id),Q(!1),Y(null)},[]),he=r.useRef(!0),M=we(r.useCallback((n,c,i={})=>{if(!he.current)return he.current=!0,Promise.resolve(void 0);const{query:y={},searchText:k=""}=o?n(o):{};let I;k?.trim()?(I=`self.isDirectory = FALSE${b.id?` AND self.parent.id = ${b.id}`:""}`,v!==b.id&&(he.current=!1,oe(b))):I=v?`self.parent.id = ${v}`:"self.parent IS NULL";const _=je?.map(C=>`${C.order==="desc"?"-":""}${C.name}`);return s.search({sortBy:_,filter:{...y,_domain:`${f.domain?`${f.domain} AND `:""}${I}`},offset:0,...i,...i.fields&&{fields:Yt([...i.fields,"isDirectory","parent.id","relatedModel","relatedId","metaFile.id"])}}).then(C=>{const{records:ye}=C,Re=ye.filter(J=>J.isDirectory),_t=Re.map(J=>J.id);return X(J=>[...J.filter(wt=>!_t.includes(wt.id)),...Re]),C})},[o,je,s,f.domain,oe,b,v])),z=r.useCallback(async(n,c,i)=>{const y=A(),k=s.records.filter(_=>_.fileName===c&&(!i?.isDirectory||_.isDirectory===!0));k.length>0&&(c=`${c} (${k.length+1})`);const I=await qe(n,c);if(I){const _=await s.save({relatedId:te,relatedModel:se,fileName:I,...i,...y?.id&&y.id>0&&{parent:{id:y.id}}});return _&&!ne(_)&&M({}),_}},[te,se,s,ne,A,M]),ve=r.useCallback(async()=>z(l.get("Create folder"),l.get("New Folder"),{isDirectory:!0}),[z]),et=r.useCallback(async()=>{const n=await z(l.get("Create document"),l.get("New Document"),{isDirectory:!1,contentType:K.HTML});n&&H(n)},[z,H]),tt=r.useCallback(async()=>{const n=await z(l.get("Create spreadsheet"),l.get("New Spreadsheet"),{isDirectory:!1,contentType:K.SPREADSHEET});n&&H(n)},[z,H]),st=r.useCallback(async()=>{const n=R(),c=A(),i=n||c;if(!i)return;const y=await qe(l.get("Information"),i.fileName,l.get("Save"));if(y){const k=await s.save({id:i.id,version:i.version,fileName:y});k&&!n&&X(I=>I.map(_=>_.id===k.id?{..._,fileName:k.fileName}:_))}},[A,R,s]),nt=r.useCallback(n=>s.save(n),[s]),ot=r.useCallback(async()=>{const n=Ne();n&&He(n)},[Ne]),rt=r.useCallback(()=>{const n=R();n&&j({title:l.get("Permissions {0}",n.fileName),model:d.model,viewName:"dms-file-permission-form",record:n,readonly:!1,onSelect:()=>{}})},[d,j,R]),at=r.useCallback(()=>{const n=R();n&&n.relatedId>0&&n.relatedModel&&D(`/ds/form::${n.relatedModel}/edit/${n.relatedId}`)},[D,R]),ct=r.useCallback(async()=>{const n=V(),c=A();if(!n&&!c)return;const i=n||[c],[y]=i;if(await be.confirm({content:i.length>1?l.get("Are you sure you want to delete the {0} selected documents?",i.length):t.jsx(u,{dangerouslySetInnerHTML:{__html:l.get("Are you sure you want to delete {0}?",Ks(Qt(y.fileName)))}})})&&await s.delete(i)){const _=i.filter(C=>C.isDirectory).map(C=>C.id);_.length>0&&X(C=>C.filter(ye=>!_.includes(ye.id))),fe(C=>_.includes(C)?b.id:C)}},[V,A,b,s]),Te=r.useCallback(async n=>{if(n){for(let c=0;c<n.length;c++){const i=n?.[c];if(i&&ee>0&&i.size>1048576*ee)return be.info({content:l.get("You are not allowed to upload a file bigger than {0} MB.",ee)})}for(let c=0;c<n.length;c++)L.queue({file:n[c]});await L.process()}},[ee,L]),it=r.useCallback(async(n,c)=>{if(c.find(y=>y.id===n.id))return;const i=await s.save(c.map(({id:y,version:k})=>({id:y,version:k,parent:n.id?{id:n.id}:null})));i&&(i.forEach(y=>{y.isDirectory&&X(k=>k.some(_=>_.id===y.id)?k.map(_=>_.id===y.id?{..._,"parent.id":n.id}:_):[...k,{...y,"parent.id":n.id}])}),M({}))},[s,M]),Ee=we(r.useCallback((n,c)=>{o&&c(o,i=>({...i,query:void 0,searchText:void 0}))},[o])),re=r.useCallback(n=>{oe(n),Ee()},[oe,Ee]),lt=r.useCallback(n=>{De(c=>c.includes(n.id)?c.filter(i=>i!==n.id):[...c,n.id])},[]),ae=r.useCallback((n,c)=>{c?.record?.isDirectory?re(c.record):c?.record?.id&&H(c?.record)},[re,H]),dt=r.useCallback(()=>{Q(!1)},[]),ut=r.useCallback((n,c,i,y)=>{const k=y?.record;c?.name==="typeIcon"&&k.isDirectory?ae(n,y):c?.name==="downloadIcon"?y?.record&&He(y.record):c?.name==="detailsIcon"?(Q(!0),Y(k.id)):c?.name==="typeIcon"&&ae(n,y),c?.name!=="detailsIcon"&&(Q(!1),Y(null))},[ae]),mt=g?.showToolbar!==!1,{offset:ce=0,limit:ge=ls,totalCount:ft=0}=s.page,pt=ce>0,ht=ce+ge<ft,xe=Zt(s,n=>n.records),gt=r.useMemo(()=>{function n(c){const i=U.find(y=>y.id===c);return i?n(i["parent.id"]).concat([i]):[]}return n(v)},[U,v]),xt=r.useMemo(()=>ue?xe.find(n=>n.id===ue):null,[xe,ue]);r.useEffect(()=>{const n=A();L.setSaveHandler(async c=>{const i=await s.save({relatedId:te,relatedModel:se,...c,...n?.id&&n.id>0&&{parent:{id:n.id}}});return i&&ne(i),i})},[te,se,L,s,A,ne]),r.useEffect(()=>{!me&&Y(null)},[me]),r.useEffect(()=>{x&&h({data:{selected:V()}})},[x,V,h]),es("grid",M);const Ae=ts(),yt=Qe??!(Ae.xs||Ae.sm);return t.jsx(ss,{children:t.jsxs(Cs,{className:W($.container,{[$.popup]:x}),onUpload:Te,children:[mt&&t.jsx(ns,{meta:e,actions:[{key:"toggle",text:l.get("Toggle"),iconOnly:!0,iconProps:{icon:"menu"},onClick:()=>Ze(n=>!n)},{key:"new",text:l.get("New"),hidden:!S("new"),iconOnly:!1,onClick:ve,items:[{key:"folder",text:l.get("Folder"),onClick:ve},{key:"d1",divider:!0},{key:"document",text:l.get("Document"),onClick:et},{key:"spreadsheet",text:l.get("Spreadsheet"),onClick:tt,hidden:!pe},{key:"d2",divider:!0},{key:"file_upload",text:l.get("File upload"),onClick:()=>Se.current?.click?.()}]},{key:"more",text:l.get("More"),iconProps:{icon:"more_vert"},disabled:v===b.id&&!B?.length,items:[{key:"rename",text:l.get("Rename..."),onClick:st},{key:"permissions",text:l.get("Permissions..."),onClick:rt,hidden:!B?.length},{key:"attached",text:l.get("Attached to..."),onClick:at,hidden:!!w.params?.popup||!(R()?.relatedId>0&&R()?.relatedModel)},{key:"d1",divider:!0},{key:"download",text:l.get("Download"),onClick:ot},{key:"d2",divider:!0},{key:"delete",text:l.get("Delete..."),onClick:ct}]}],pagination:{canPrev:pt,canNext:ht,onPrev:()=>M({offset:ce-ge}),onNext:()=>M({offset:ce+ge}),text:()=>t.jsx(os,{dataStore:s})},children:t.jsxs(u,{d:"flex",className:$.toolbar,children:[o&&t.jsx(rs,{stateAtom:o,dataStore:s,items:d.items,customSearch:d.customSearch,freeSearch:d.freeSearch,onSearch:M}),t.jsx(u,{d:"flex",flex:1,alignItems:"center",className:$.breadcrumbs,children:t.jsx(cn,{root:b,data:gt,selected:v,onSelect:re})})]})}),t.jsx(as,{scope:Xe,value:{getSelectedDocuments:V},children:t.jsxs(u,{className:$.content,children:[t.jsx(Ue,{type:"file",multiple:!0,ref:Se,d:"none",onChange:n=>Te(n.target.files)}),t.jsx(u,{className:W($.tree,{[$.hide]:!yt}),children:t.jsx(Is,{root:b,data:U,expanded:Ye,selected:v,onDrop:it,onSelect:re,onExpand:lt})}),t.jsxs(u,{className:$.grid,ref:Ce,children:[t.jsx(cs,{records:xe,view:d,fields:m,state:E,setState:de,sortType:"live",rowRenderer:an,onSearch:M,onCellClick:ut,onRowDoubleClick:ae}),t.jsx(_s,{open:me,data:xt,onView:H,onSave:nt,onClose:dt})]}),t.jsx(Vs,{})]})}),t.jsx(Bs,{uploader:L})]})})}const Ke=new Image;Ke.src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==";function an(a){const{selected:e,data:s,index:o}=a,{children:d,style:m,className:f,onDoubleClick:x}=a,g=r.useRef(null),[,p,S]=is({type:le,item:{data:s,index:o,type:le}});return p(g),r.useEffect(()=>{S(Ke,{captureDraggingState:!0})},[S]),t.jsx(t.Fragment,{children:t.jsx(u,{ref:g,position:"relative",style:m,className:Oe(f,Me.row,{[Me.selected]:e}),onDoubleClick:x,children:d})})}const _e=3;function cn({root:a,data:e,selected:s,onSelect:o}){const d=r.useMemo(()=>{if(e.length<=_e)return e;const[m,...f]=e;return[m,{...f.slice(-_e)[0],$displayName:"..."},...f.slice(1-_e)]},[e]);return t.jsx(u,{as:"ul",children:d.map((m,f)=>{function x(){return m.id===a.id?t.jsx(F,{icon:"home",fill:!0}):m.$displayName??m.fileName}return t.jsxs(u,{as:"li",children:[s===m.id&&m.id?t.jsx(u,{as:"span",children:x()}):t.jsx(ie,{onClick:()=>o?.(m),title:m.fileName,children:x()}),f<d.length-1&&t.jsx(u,{as:"span",color:"secondary",children:t.jsx(F,{icon:"chevron_right"})})]},f)})})}export{dn as Dms};
