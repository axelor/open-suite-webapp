const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BnIIKaWx.js","./index-BIOZ3xfM.js","./index-tyK1EuJX.css","./index-FlmozaCS.css","./index-BxovMTLk.js"])))=>i.map(i=>d[i]);
import{r as a,az as me,j as C,aA as z,aB as he,aC as xe,aD as ye,aE as ke,t as re,aF as be,aG as Ce,aH as ce,aI as _e,a9 as ge,h as ve,i as $e,aJ as le,aK as se,a5 as Ne,q as De,W as Se,Z as Te,k as ie,_ as we,n as Ee,$ as Re,v as je,B as ae,a0 as Ae,a1 as Ie,D as fe,aL as Me,a3 as Pe}from"./index-BIOZ3xfM.js";function de({$key:i,_draggable:t,_droppable:d,...p}){return{$key:i,id:p.id,data:p,children:p._children,draggable:t,droppable:d,level:0}}function ue(i,t){const d=p=>i.filter(u=>u.parent===p).reduce((u,x)=>[...u,x.$key,...d(x.$key)],[]);return d(t)}function Le(i,t){const d=p=>p?i.filter(u=>u.$key===p).reduce((u,x)=>[...u,x.$key,...d(x.parent)],[]):[];return d(t)}function Oe(i){const{className:t,sortable:d,droppable:p,droppableText:u,onLoad:x,onSort:y,onNodeMove:$,onNodeEdit:T,onNodeSave:R,onNodeDiscard:W,columns:q,records:H,nodeRenderer:j,textRenderer:g,editNodeRenderer:V}=i,[_,f]=a.useState([]),[Q,B]=a.useState(!1),[k,D]=a.useState(null),[w,A]=a.useState(null),M=a.useRef({}),F=a.useCallback(o=>{f(s=>s.map((r,l)=>l===o?{...r,selected:!0}:r.selected?{...r,selected:!1}:r))},[]),X=a.useCallback((o,s)=>{A(r=>{r||(r=[]);const l=r.find(e=>e.name===s.name);return l?(o.shiftKey||(r=[l]),r.map(e=>e.name===s.name?{...e,order:e.order==="asc"?"desc":"asc"}:e)):[...o.shiftKey?r:[],{name:s.name,order:"asc"}]})},[]),P=a.useCallback(async function(s,r,l=!1){if(!M.current[s.$key]&&s.children&&x){M.current[s.$key]=!0;try{B(!0);const c=await x(s,w||[]);f(n=>{const m=n.findIndex(b=>b.$key===s.$key);return[...n.slice(0,m+1),...c.map(b=>({...de(b),parent:s.$key})),...n.slice(m+1)]})}finally{B(!1)}}M.current[s.$key]=!0;const e=l?"hover":"selected";f(c=>c.map(n=>n[e]?{...n,[e]:!1}:n).map(n=>n.$key===s.$key?{...n,[e]:!0,expanded:!s.expanded}:(s.childrenList||[]).includes(n.$key)?{...n,hidden:!!s.expanded}:n))},[x,w]),G=a.useCallback(async function(s,r,l){D(null),r.children?await P(r,l):F(l)},[P,F]),U=a.useCallback(async function({data:s},{data:r}){B(!0);try{const l=r,e=p&&r.data===null;let c={...s};l.$key!==s.parent&&$&&(c=await $(s,l)),f(n=>{const m=n.findIndex(v=>v.$key===s?.$key);n.splice(m,1);const b=e?n.length-1:n.findIndex(v=>v.$key===r?.$key);n.splice(b+1,0,{...c,parent:l.$key});let h=s,N=s;const E=ue(n,s.$key);return E.length>0&&E.forEach(v=>{const K=n.findIndex(S=>S.$key===v);K>-1&&(h=n[K],n.splice(K,1));const O=n.findIndex(S=>S.$key===N.$key);O>-1&&(n.splice(O+1,0,h),N=h)}),[...n]})}finally{B(!1)}},[p,$]),Y=a.useCallback(o=>{D(o)},[]),I=a.useCallback(async(o,s)=>{R&&(o.data=await R(o.data)),D(null),f(r=>r.map((l,e)=>e===s?o:l))},[R]),L=a.useCallback(o=>{D(null),W&&W(o)},[W]),ee=o=>{let s=_.findIndex(l=>l.selected),r=s;if(r>-1)switch(o.key){case"Enter":return G({},_[r],r);case"ArrowUp":for(let l=0;l<_.length;l++)l<s&&!_[l].hidden&&(r=l);break;case"ArrowDown":for(let l=0;l<_.length;l++)if(l>s&&!_[l].hidden){r=l;break}break}F(Math.max(0,r))};a.useEffect(()=>{M.current={};const[o]=w||[];f((o&&!y?[...H].sort((s,r)=>{const l=s[o.name],e=r[o.name];return l>e?o.order==="asc"?1:-1:l<e?o.order==="asc"?-1:1:0}):[...H]).map(de))},[H,w,y]),a.useEffect(()=>{y&&w&&y(w)},[w,y]),a.useEffect(()=>{k&&T&&T(k)},[k,T]);const te=me(),ne=a.useMemo(()=>_.map(o=>{const s=ue(_,o.$key),r=Le(_,o.parent);return{...o,...M.current[o.$key]?{children:!!s.length}:{},level:r.length,childrenList:s}}),[_]);return C.jsxs("div",{className:te("table-tree",t,z.tree,{[z.loading]:Q}),...k?{}:{tabIndex:0,onKeyDown:ee},children:[C.jsx("div",{className:z.header,children:q.map(o=>{const s=(w||[]).find(r=>r.name===o.name);return C.jsx(he,{data:o,...s?{sort:s.order}:{},...d?{onSort:X}:{}},o.name)})}),C.jsxs("div",{className:z.body,children:[ne.map((o,s)=>!o.hidden&&C.jsx(xe,{index:s,columns:q,edit:k===o,data:o,renderer:j,textRenderer:g,editRenderer:V,onToggle:P,onSelect:G,...k?{}:{onDrop:U},onEdit:Y,onSave:I,onCancel:L},s)),p&&C.jsx(ye,{text:u,onDrop:U})]})]})}function J(i,t,d=!1){return i.nodes?.[Math.min((t.level??0)+(d?1:0),i.nodes?.length-1)]}function He({data:i,view:t,actionExecutor:d,children:p}){const u=J(t,i),x=a.useCallback(y=>{u&&u.onClick&&d.execute(u.onClick,{context:{...i.data,_model:u?.model}})},[d,i.data,u]);return u?.onClick?a.cloneElement(p,{onDoubleClick:x}):p}function Ve(i){return ke(async()=>{const t=re(i),d=be(i),{[d]:p}=await Ce(Object.assign({"./widgets/button/index.ts":()=>ce(()=>import("./index-BnIIKaWx.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),"./widgets/image-select/index.ts":()=>ce(()=>import("./index-BxovMTLk.js"),__vite__mapDeps([4,1,2]),import.meta.url)}),`./widgets/${t}/index.ts`,4);return p},[i])}function Be({column:i,data:t,view:d,actionExecutor:p}){const u=J(d,t),{data:x}=t;let y=_e(x,i.name);const $=a.useMemo(()=>({...i,...u?.items?.find(R=>(R.as||R.name)===i.name)}),[u,i]),{data:T}=Ve(re(i.widget||i.type));return T&&$?C.jsx(T,{field:$,node:u,record:x,actionExecutor:p}):$?.targetName?y&&y[$.targetName]:($?.type&&(y=ge(y,{props:{...$,...i,...i.widgetAttrs},context:x})),!y&&y!==0||typeof y=="object"?"---":y)}const Ke="_container_iiiou_1",We="_tree_iiiou_5",qe="_placeholder_iiiou_16",oe={container:Ke,tree:We,placeholder:qe};function Ue({meta:i}){const{view:t}=i,{action:d,dashlet:p,popup:u,popupOptions:x}=ve(),[y,$]=a.useState([]),[T,R]=a.useState([]),[W,q]=a.useReducer(e=>e+1,0),H=$e(),j=a.useCallback(e=>{const c=H(e);return{...c,_viewName:t.name,_viewType:t.type,_views:d.views,_model:c?._model||t.nodes?.[0]?.model}},[H,d,t]),g=a.useMemo(()=>{const e=t?.nodes?.[0]?.model;return t?.nodes?.every?.(c=>c.model===e)},[t]),V=a.useCallback(e=>{const{items:c=[]}=e;return T.length===0?{}:{sortBy:T.map(n=>{const m=c.find(b=>b.as===n.name);return m?`${n.order==="desc"?"-":""}${m.name}`:null}).filter(n=>n)}},[T]),_=a.useCallback((e,c)=>{const{model:n,draggable:m,items:b=[]}=e;return c.map(h=>({...b.reduce((N,E)=>E.as?{...N,[E.as]:N[E.name]}:N,h),_draggable:m||g,_droppable:e===t.nodes?.[0]||g,$key:`${n}:${h.id}`}))},[t,g]),f=a.useMemo(()=>{const{nodes:e}=t,{model:c,items:n=[]}=e?.[0]||{},m=le(n.map(b=>b.name));return c?new se(c,{fields:m}):null},[t]),Q=a.useMemo(()=>(t.columns||[]).map(e=>{const c={title:e.title||e.autoTitle||Ne(e.name)};return re(e.type??"")==="button"&&(c.title="",c.width=50),{...e,...c}}),[t]),B=a.useCallback(async(e={})=>{if(f){const{nodes:c}=t,n=c?.[0],{_domainAction:m,...b}=j()||{};let h=n?.domain;return d.domain&&(h=`${d.domain.trim()}${h?` AND (${h})`:""}`),f.search({...n&&V(n),...e,filter:{...e.filter,...h&&{_domain:h},_domainAction:m,_domainContext:{...e?.filter?._domainContext,...b,...g?{_countOn:c?.[1]?.parent}:{_childOn:{model:c?.[1]?.model,parent:c?.[1]?.parent}}}}})}},[f,t,d.domain,g,V,j]),k=De(B),D=a.useCallback(async()=>{q(),await k({})},[q,k]),w=a.useCallback(()=>j(!0),[j]),A=Se(t,{getContext:w,onRefresh:D}),M=a.useCallback(async e=>{const c=J(t,e,!0),{_domainAction:n,...m}=j()??{};if(!c)return[];const{model:b,domain:h,parent:N,items:E=[]}=c,v=g?N:"",K=le(E.map(S=>S.name)),O=new se(b,{fields:K,filter:{...N&&{_domain:`self.${N}.id = :_parentId ${h?`AND (${h})`:""}`},_domainAction:n,_domainContext:{...m,...v&&{_countOn:v},_parentId:e.id}}});return _(c,(await O.search(V(c))).records)},[t,g,_,j,V]),F=a.useCallback(async(e,c)=>{const n=e.data,m=J(t,e);if(!m)return e;const[b]=t.nodes?.slice(-1)??[],{parent:h=g?b?.parent:"",model:N,items:E=[]}=m;let v={id:n.id,version:n.version,...h&&{[h]:c.data?{id:c.data?.id,version:c.data?.version}:null}};if(m?.onMove){const S=await A.execute(m?.onMove,{context:{...v,_model:m.model}});v={...v,...S?.reduce?.((Z,{values:pe})=>({...Z,...pe}),{})}}const O=await new se(N).save(v);return O?{...e,data:E.reduce((S,Z)=>Z.as?{...S,[Z.as]:S[Z.name]}:S,{...n,...O})}:e},[t,g,A]),X=a.useCallback(e=>{e&&R(e)},[]);Te(async()=>{await k()},[k]);const P=t.nodes?.[0];a.useEffect(()=>{if(f&&P){const e=()=>$(()=>_(P,f.records));return e(),f.subscribe(()=>{e()})}},[P,f,_,W]);const G=ie(we()),U=ie(Ee());a.useEffect(()=>{u&&f&&G({dataStore:f,onSearch:k})},[k,u,f,G]),a.useEffect(()=>{p&&f&&U({dataStore:f,view:t,onRefresh:D})},[p,t,f,D,U]);const Y=x?.showToolbar!==!1,{offset:I=0,limit:L=Pe,totalCount:ee=0}=f?.page||{},te=I>0,ne=I+L<ee,o=a.useMemo(()=>e=>C.jsx(He,{...e,view:t,actionExecutor:A}),[t,A]),s=a.useMemo(()=>e=>C.jsx(Be,{...e,view:t,actionExecutor:A}),[t,A]),r=a.useCallback(()=>k({offset:I-L}),[L,I,k]),l=a.useCallback(()=>k({offset:I+L}),[L,I,k]);return Re({viewType:t.type,onRefresh:D}),je("tree",D),C.jsxs(ae,{className:oe.container,d:"flex",flexDirection:"column",overflow:"auto",w:100,children:[Y&&C.jsx(Ae,{meta:i,actions:[],pagination:{canPrev:te,canNext:ne,onPrev:r,onNext:l,text:()=>f&&C.jsx(Ie,{dataStore:f}),actions:[{key:"refresh",text:fe.get("Refresh"),iconOnly:!0,iconProps:{icon:"refresh"},onClick:D}]},children:C.jsx(ae,{fontWeight:"bold",children:t.title})}),C.jsx(Me,{children:C.jsx(Oe,{className:oe.tree,columns:Q,records:y,sortable:!0,...g&&{droppable:g,droppableText:C.jsx(Fe,{})},nodeRenderer:o,textRenderer:s,onSort:X,onLoad:M,onNodeMove:F})})]})}function Fe(){return C.jsx(ae,{className:oe.placeholder,d:"flex",flex:1,alignItems:"center",justifyContent:"center",children:fe.get("Drop here")})}export{Ue as Tree};
