import{j as t,B as x,bp as Ce,r,bq as _e,az as $e,br as Me,E as ce,D as P,O as qe,ai as Y,bs as ye,a_ as Ve,bt as Le,h as Fe,ad as Ke,bu as He,Q as ze,P as Oe,bv as We,S as Ge,i as Je,bw as Qe,aK as Ue,aJ as Ze,U as Ye,W as Xe,H as et,aI as oe,k as we,_ as tt,n as nt,Z as st,v as ot,bx as at,by as rt,Y as ct,$ as lt,z as X,a0 as it,a2 as dt,bz as ut,bA as mt,bB as pt,bC as ge}from"./index-Hj3ihs7h.js";import{u as ft,C as xt}from"./use-card-classname-wGl3EELR.js";const ht="_board_uk323_1",bt="_column_uk323_8",yt="_record_uk323_13",ee={board:ht,column:bt,"record-list":"_record-list_uk323_13",record:yt},wt=({column:e,readonly:n,RecordList:o})=>t.jsxs(x,{p:2,bg:"body-tertiary",border:!0,rounded:!0,me:2,className:ee.column,children:[t.jsx(x,{as:"h5",p:2,children:e.title}),t.jsx(o,{column:e,readonly:n,className:ee["record-list"]})]}),gt=({record:e})=>t.jsx(x,{p:2,mt:2,shadow:"sm",rounded:!0,className:ee.record,children:t.jsx(x,{as:"p",pb:1,pt:1,children:e.title})});function Ct({record:e,column:n,index:o,readonly:d}){const{renderer:s=gt}=e;return t.jsx(Ce,{index:o,draggableId:String(e.id),isDragDisabled:d||n.readonly,children:({innerRef:u,draggableProps:c,dragHandleProps:h},{isDragging:g})=>t.jsx(x,{ref:u,...c,...h,children:t.jsx(s,{record:e,column:n,isDragging:g})})})}const _t=r.memo(function({column:n,readonly:o,style:d,className:s}){const{records:u}=n;return t.jsx(_e,{droppableId:String(n.id),type:"card",isDropDisabled:o||n.readonly,children:({innerRef:c,droppableProps:h,placeholder:g})=>t.jsxs(x,{ref:c,...h,d:"flex",flexDirection:"column",style:d,className:s,children:[u?.map((b,l)=>t.jsx(Ct,{record:b,column:n,index:l,readonly:o},b.id)),g]})})});function jt({column:e,index:n,readonly:o,className:d,style:s}){const{renderer:u=wt,id:c,disableDrag:h=!0}=e;return t.jsx(Ce,{draggableId:String(c),index:n,isDragDisabled:o||e.readonly||h,children:({innerRef:g,draggableProps:b,dragHandleProps:l})=>t.jsx(x,{ref:g,...b,...l,className:d,style:{...s,...b.style},children:t.jsx(u,{RecordList:_t,column:e,readonly:o})})})}function vt({columns:e,onColumnMove:n,onCardMove:o,readonly:d,className:s,ColumnProps:u}){const c=r.useCallback(b=>e?.find(l=>String(l.id)===String(b)),[e]),h=r.useCallback(b=>{const{source:l,destination:i,type:k}=b;if(i&&!(l.droppableId===i.droppableId&&l.index===i.index)){if(k==="column"&&n){n({column:e[l.index],index:i.index});return}else if(k==="card"&&o){const C=c(l.droppableId),R=c(i.droppableId),B=c(l.droppableId).records[l.index];o({column:R,source:C,record:B,index:i.index})}}},[e,o,n,c]),g=$e();return t.jsx(Me,{onDragEnd:h,children:t.jsx(_e,{droppableId:"kanban",type:"column",direction:"horizontal",isDropDisabled:d,children:({innerRef:b,droppableProps:l,placeholder:i})=>t.jsxs(x,{ref:b,...l,className:g(ee.board,s),children:[e?.map((k,C)=>t.jsx(jt,{column:k,index:C,readonly:d,...u},k.id)),i]})})})}const kt="_board_1ynbw_1",St="_responsive_1ynbw_9",Nt="_collapsed_1ynbw_20",Dt="_column_1ynbw_13",It="_overflow_1ynbw_56",Rt="_record_1ynbw_50",I={board:kt,responsive:St,"column-wrapper":"_column-wrapper_1ynbw_13",collapsed:Nt,column:Dt,"column-title":"_column-title_1ynbw_38","collapsed-column-title":"_collapsed-column-title_1ynbw_45","record-list-wrapper":"_record-list-wrapper_1ynbw_50",overflow:It,"no-data":"_no-data_1ynbw_59","record-list":"_record-list_1ynbw_50",record:Rt,"record-action":"_record-action_1ynbw_72","bottom-column-text":"_bottom-column-text_1ynbw_92"};function At({record:e,column:n,onCardEdit:o,onCardDelete:d,onCardClick:s,Card:u}){const c=!!o,h=!!d,g=[{key:"menu",iconProps:{icon:"arrow_drop_down"},items:[{key:"edit",text:P.get("Edit"),hidden:!c,onClick:()=>o&&o({record:e,column:n})},{key:"delete",text:P.get("Delete"),hidden:!h,onClick:()=>d&&d({record:e,column:n})}]}],b=c||h,l=r.useCallback(i=>{c&&s&&s({record:e,column:n})},[c,s,e,n]);return t.jsxs(x,{className:I.record,d:"flex",alignItems:"flex-start",justifyContent:"space-between",position:"relative",children:[t.jsx(x,{w:100,onClick:l,children:t.jsx(u,{record:e})}),b&&t.jsx(qe,{className:I["record-action"],items:g})]})}function Et({column:e,readonly:n,overflow:o,onCollapse:d,onLoadMore:s,onCardAdd:u,RecordList:c,scrollTop:h,handleScroll:g}){const[b,l]=r.useState(""),{title:i,canCreate:k,loading:C}=e,R=e.dataStore.page,B=(R.totalCount??0)>(e?.records?.length??0),w=!C&&!R.totalCount;function E(){l(""),u?.({record:{text:b},column:e})}const j=r.useCallback(()=>{d?.(e)},[e,d]),$=r.useRef(null);return r.useEffect(()=>{const v=$.current;v&&h!=null&&(v.scrollTop=h)},[h]),e.collapsed?t.jsxs(x,{d:"flex",flexDirection:"column",rounded:3,p:3,className:I.collapsed,children:[t.jsx(Y,{onClick:j,border:!1,m:0,p:2,children:t.jsx(ye,{icon:"chevron-right"})}),t.jsx(x,{as:"h6",className:`${I["column-title"]} ${I["collapsed-column-title"]}`,children:i})]}):t.jsxs(x,{p:3,gap:"0.5rem",h:100,d:"flex",rounded:3,flexGrow:1,flexDirection:"column",className:I.column,children:[t.jsxs(x,{d:"flex",mb:1,p:2,justifyContent:"space-between",children:[t.jsxs(x,{d:"flex",children:[t.jsx(Y,{d:"flex",onClick:j,border:!1,p:0,me:2,children:t.jsx(ye,{icon:"chevron-down"})}),t.jsx(x,{as:"h6",className:I["column-title"],children:i})]}),t.jsx(x,{alignSelf:"center",style:{fontSize:"small"},children:`${e?.records?.length}/${R.totalCount??0}`})]}),k&&u&&t.jsxs(x,{d:"flex",g:2,children:[t.jsx(Ve,{ps:2,pe:2,border:!0,rounded:!0,value:b,onChange:v=>l(v.target.value)}),t.jsx(Y,{disabled:!b.trim(),variant:"primary",onClick:E,flexShrink:0,children:P.get("Add")})]}),t.jsxs(x,{className:ce(I["record-list-wrapper"],{[I.overflow]:o,[I["no-data"]]:w}),onScroll:g,ref:$,children:[t.jsx(c,{column:e,readonly:n,className:I["record-list"]}),B&&!w&&t.jsxs(x,{d:"flex",flexDirection:"column",justifyContent:"center",py:2,children:[t.jsx(x,{d:"flex",justifyContent:"center",py:2,className:I["bottom-column-text"],children:P.get("Showing {0} of {1} items.",e.records?.length,R.totalCount)}),t.jsx(Y,{onClick:()=>s?.({column:e}),outline:!0,size:"sm",variant:"secondary",alignSelf:"center",children:P.get("Load more")})]}),!B&&!w&&!C&&t.jsx(x,{d:"flex",justifyContent:"center",py:2,className:I["bottom-column-text"],children:P.get("Showing all items.")}),w&&t.jsx(x,{py:2,textAlign:"center",className:I["bottom-column-text"],children:P.get("No records found.")}),C&&t.jsx(x,{d:"flex",h:100,children:t.jsx(Le,{})})]})]})}function Tt({columns:e,columnWidth:n,readonly:o,responsive:d,components:s,onCollapse:u,onLoadMore:c,onCardAdd:h,onCardMove:g,onCardClick:b,onCardDelete:l,onCardEdit:i}){const{Card:k}=s,C=r.useRef(),R=r.useMemo(()=>e.map(E=>({...E,id:`column-${E.title}-${E.name}`,records:E.records?.map(j=>({...j,title:j.title||j.name,renderer:({column:$})=>t.jsx(At,{record:j,column:$,onCardClick:b,onCardDelete:l,onCardEdit:i,Card:k})})),disableDrag:!0,renderer:({column:j,readonly:$,RecordList:v})=>t.jsx(Et,{column:j,readonly:$,RecordList:v,overflow:!d,onCollapse:u,onCardAdd:h,onLoadMore:c,scrollTop:C.current?.[j.name??""],handleScroll:L=>{C.current||(C.current={}),C.current[j.name??""]=L.target.scrollTop}})})),[e,d,u,c,h,b,l,i,k]),B=r.useMemo(()=>({className:I["column-wrapper"],style:{width:n}}),[n]),w=ce(I.board,{[I.responsive]:d});return t.jsx(vt,{readonly:o,columns:R,className:w,onCardMove:g,ColumnProps:B})}function je(e,n,o){return e.findIndex(d=>d[n]===o)}function z(e,n){return je(e,"name",n)}function Bt(e,n){return je(n,"id",e)}function ae(e,n){const o=z(e,n);return e[o].records||[]}function Pt(e,n,o){const d=Array.from(e),[s]=d.splice(n,1);return d.splice(o,0,s),d}function $t({columns:e,sourceColumn:n,destinationColumn:o,sourceIndex:d,destinationIndex:s}){const u=ae(e,n.name)?.slice(),c=ae(e,o.name)?.slice(),h=u[d];if(n.name===o.name){const i=Pt(u,d,s),k=e.map(C=>({...C}));return k[z(e,n.name)].records=i,k}u.splice(d,1),c.splice(s,0,h);const g=e.map(i=>({...i})),b=g[z(e,n.name)],l=g[z(e,o.name)];return b.records=u,l.records=c,b.dataStore.page.totalCount&&b.dataStore.page.totalCount--,l.dataStore.page.totalCount?l.dataStore.page.totalCount++:l.dataStore.page.totalCount=1,g}const Mt="_kanban_hva70_1",re={kanban:Mt,"kanban-card":"_kanban-card_hva70_9"};function Ft(e){const{meta:n,dataStore:o,searchAtom:d}=e,{view:s,fields:u}=n,{action:c,dashlet:h,popup:g,popupOptions:b}=Fe(),[l,i]=Ke(r.useMemo(()=>He([]),[])),k=r.useRef(l);r.useEffect(()=>{k.current=l},[l]);const{hasButton:C}=ze(n.view,n.perms),R=Oe(),{params:B}=c,{columnBy:w,editWindow:E,onDelete:j,limit:$=+B?.limit||We,sequenceBy:v}=s,L=h||E==="popup",le=L||E==="popup-new",ie=B?.["kanban-hide-columns"]||"",ve=B?.["kanban-column-width"],de=Ge(c,h),Q=Je(),F=r.useCallback(()=>({...Q(!0),_model:c.model}),[c.model,Q]),ke=r.useCallback(()=>({...F(),_viewName:c.name,_viewType:c.viewType,_views:c.views}),[c.name,c.viewType,c.views,F]),K=r.useCallback(a=>{const m=u?.[w??""];return Qe(a)?a:m?.target?{id:a}:a},[u,w]),ue=r.useMemo(()=>{const a=s.collapseColumns?.split(/\s*,\s*/);return(s.columns||u?.[w??""]?.selectionList||[]).map((m,_)=>{const{title:y,value:p}=m,f={id:p,title:y,name:p,dataStore:new Ue(o.model,o.options)};return s.onNew&&_===0&&(f.canCreate=!0),a?.includes(f.name)&&(f.collapsed=!0),f})},[s,o,w,u]),U=r.useMemo(()=>{const a=Object.keys(u??{});return Ze([...a,w,v].filter(m=>m))},[u,w,v]),Z=Ye(r.useCallback((a,m,_,y={})=>{const{query:p=null}=d?a(d):{};let f={criteria:[{fieldName:w,operator:"=",value:K(_.name)}],operator:"and"};const{criteria:N,operator:T,...S}=p||{};if(N?.length?f={...S,operator:"and",criteria:[{criteria:N,operator:T},f]}:f={...f,...S},h){const{_domainAction:te,...D}=Q()??{};f._domainContext={...f?._domainContext,...D},f._domainAction=te}return _.dataStore.search({...v&&{sortBy:[v]},filter:f,limit:$,fields:U,...y})},[h,d,$,w,v,U,Q,K])),H=r.useCallback((a={},m)=>{const _=ie.split(/\s*,\s*/);let y=k.current;y.length?y=y.map(p=>p.collapsed?{...p,loading:!0,...m?.includes(p.name)&&{collapsed:!1}}:p):y=(ue||[]).filter(p=>!_.includes(p.name)).map(p=>({...p,loading:!0,records:[]})),i(y),y.forEach((p,f)=>{p.collapsed&&!m||m&&!m.includes(p.name)||Z(p,a).then(({records:N})=>{i(T=>{const S=T[f];S&&(S.loading=!1,S.records=N)})})})},[ue,ie,Z,i]),A=r.useCallback(()=>H({offset:0}),[H]),M=Xe(s,{getContext:ke,onRefresh:A}),Se=r.useCallback(a=>{i(m=>{const _=m.find(y=>y.name===a.name);_&&(_.collapsed=!_.collapsed)}),a.loading&&H({offset:0},[a.name])},[i,H]),Ne=r.useCallback(({column:a})=>{const{name:m,records:_}=a;Z(a,{offset:_?.length??0}).then(({records:y})=>{i(p=>{const f=p.findIndex(N=>N.name===m);p[f]&&p[f].records?.push(...y)})})},[Z,i]),De=r.useCallback(async({record:a,column:m})=>{if(await et.confirm({content:P.get("Do you really want to delete the selected record(s)?"),yesTitle:P.get("Delete")})){j&&await M.execute(j,{context:a});const{id:y,version:p}=a;try{await m.dataStore.delete([{id:y,version:p}])&&i(N=>{const T=N.find(S=>S.name===m.name);T&&(T.records=T.records?.filter(S=>S.id!==y))})}catch{}}},[j,M,i]),O=r.useCallback(({record:a,column:m},_=!1)=>{const y=a.id||0,p=y>0?String(y):"";R("form",{route:{id:p},props:{readonly:_,recordId:p,...m&&{dataStore:m.dataStore}}})},[R]),W=r.useCallback(({record:a},m=!1)=>{const _=c.views?.find(f=>f.type==="form")?.name,{title:y,model:p}=s;p&&de({title:y??"",model:p,viewName:_,record:a,readonly:m,onSearch:()=>A()})},[de,s,c,A]),me=r.useCallback(()=>{le?W({record:{}}):O({record:{}})},[le,O,W]),Ie=r.useCallback(async({record:a,column:m})=>{if(s.onNew&&a&&m){const y=(await M.execute(s.onNew,{data:{_domainContext:{...F(),_value:a.text}}}))?.reduce?.((p,{values:f})=>({...p,...f}),{});if(y){const p={...y,[w]:K(m.name)},f=await m.dataStore.save(p);f&&i(N=>{const T=N.find(S=>S.name===m.name);T&&(T.records=[f,...T.records||[]])})}}},[F,K,M,i,w,s]),Re=r.useCallback(({record:a,column:m})=>{L?W({record:a,column:m},!0):O({record:a,column:m},!0)},[L,O,W]),Ae=r.useCallback(async({column:a,index:m,source:_,record:y})=>{function p(D,V,q){const{id:G,version:Pe}=D,J={id:G,version:Pe},ne=u?.[w??""]?.jsonField,se=u?.[v??""]?.jsonField;return ne&&(J[ne]=D[ne]),se&&(J[se]=D[se]),w&&ge(J,w,K(V)),v&&ge(J,v,q),J}const f=$t({columns:l,destinationColumn:a,destinationIndex:m,sourceColumn:_,sourceIndex:Bt(y.id,ae(l,_.name))}).slice();i(f);const N=[...f[z(f,a.name)]?.records||[]],T=N[m-1];let S=p(N[m],a.name,Number(T?parseInt(oe(T,v)+1):0));if(s.onMove)try{const D={...F(),...S},V=await M.execute(s.onMove,{context:D,data:{_domainContext:D}});S={...S,...V?.reduce?.((q,{values:G})=>({...q,...G}),{})}}catch{return i(l.map(D=>({...D,records:[...D.records||[]]})))}const te=[S,...N.slice(m+1,N.length).map((D,V)=>{const q=oe(S,v);return p(D,oe(D,w),q===null?null:parseInt(q)+V+1)})];try{const D=await a.dataStore.save(te,{fields:U});N.splice(m,D.length,...D);const V=z(f,a.name);i(f.map((q,G)=>G===V?{...q,records:[...N]}:q))}catch{A()}},[s,w,v,l,U,M,u,K,F,i,A]),pe=we(tt()),fe=we(nt());r.useEffect(()=>{g&&pe({dataStore:o,onSearch:A})},[A,g,o,pe]),r.useEffect(()=>{h&&fe({dataStore:o,view:s,actionExecutor:M,onRefresh:()=>A()})},[h,s,o,M,A,fe]),st(async()=>{await H({offset:0})},[H]),ot("kanban",A);const Ee=b?.showToolbar!==!1,xe=at("(max-width: 768px)"),Te=r.useMemo(()=>{const a=u?.[v??""]||{};return rt(a)},[u,v]),he=ct(s.template),Be=r.useMemo(()=>({Card:({record:a})=>t.jsx(qt,{view:s,fields:u,record:a,onRefresh:A,Template:he})}),[s,u,he,A]),be=C("new");return lt({viewType:s.type,onNew:be?me:void 0,onRefresh:A}),t.jsxs(x,{className:X(re.kanban,"kanban-view","row-fluid"),children:[Ee&&t.jsx(it,{meta:n,actionExecutor:M,actions:[{key:"new",text:P.get("New"),hidden:!be,iconProps:{icon:"add"},onClick:me},{key:"refresh",text:P.get("Refresh"),iconProps:{icon:"refresh"},onClick:()=>A()}],children:d&&t.jsx(dt,{stateAtom:d,dataStore:o,items:s.items,canExport:!1,customSearch:s.customSearch,freeSearch:s.freeSearch,onSearch:A})}),t.jsx(x,{d:"flex",flexGrow:1,overflow:xe?"auto":"hidden",className:re.board,children:t.jsx(Tt,{readonly:s.draggable===!1||!Te,responsive:xe,columnWidth:ve,columns:l,components:Be,onCollapse:Se,onLoadMore:Ne,onCardMove:Ae,onCardClick:Re,...C("delete")&&{onCardDelete:De},...C("new")&&{onCardAdd:Ie},...C("edit")&&{onCardEdit:L?W:O}})})]})}function qt({view:e,fields:n,record:o,onRefresh:d,Template:s}){const{template:u}=e,c=r.useRef(null),h=ft(e,o),g=r.useRef(),[b,l]=r.useState(!1),[i,k]=r.useState({title:"",body:""});function C(){const E=c.current,j=E&&(E.querySelector(".card-summary.popover")||E.querySelector(`.${X("card-summary")}.${X("popover")}`));j&&(j.textContent||"").trim()&&(g.current=setTimeout(()=>{l(!0),k({title:j.title,body:j.innerHTML})},500))}const R=r.useCallback(function(){l(!1),clearTimeout(g.current)},[]),B=(u||"").includes("popover"),w=ut(u);return r.useEffect(()=>()=>R(),[R]),t.jsxs(t.Fragment,{children:[t.jsx(x,{ref:c,...B?{onMouseEnter:C,onMouseLeave:R,onMouseDown:R}:{},className:ce(w?X("kanban-card"):"",re["kanban-card"],h),children:t.jsx(xt,{component:s,fields:n,record:o,onRefresh:d})}),t.jsx(mt,{arrow:!0,bg:"white",placement:"end",open:b,target:c.current,offset:[0,4],children:t.jsx(x,{style:{maxWidth:400,minWidth:200},children:t.jsx(pt,{header:i.title,children:t.jsx(x,{children:i.body&&t.jsx("div",{dangerouslySetInnerHTML:{__html:i.body}})})})})})]})}export{Ft as Kanban};
